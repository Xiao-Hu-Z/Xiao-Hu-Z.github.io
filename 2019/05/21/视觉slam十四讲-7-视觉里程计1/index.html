<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">
  <link rel="alternate" href="/atom.xml" title="xiaohu博客" type="application/atom+xml">


  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "b7ba025a"
    });
  daovoice('update');
  </script>


<link rel="stylesheet" href="/css/main.css?v=7.4.2">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="1 特征点法 视觉slam主要分为视觉前段和优化后端。前段称为视觉里程计（VO），它根据相邻图象的信息估计出粗略的相机运动，给后端提供较好的初始值。 VO的实现方法可以根据是否需要提取特征分为两类：基于特征点的方法，不使用特征点的直接方法。 基于特征点的VO运行稳定，对光照、动态物体不敏感。1.1 特征点 为了能够更好的进行图像匹配，需要在图像中选择具有代表性的区域，例如：图像中的角点、边缘和一些">
<meta property="og:type" content="article">
<meta property="og:title" content="视觉slam十四讲   7.视觉里程计1">
<meta property="og:url" content="https:&#x2F;&#x2F;xiao-hu.com.cn&#x2F;2019&#x2F;05&#x2F;21&#x2F;%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11&#x2F;index.html">
<meta property="og:site_name" content="xiaohu博客">
<meta property="og:description" content="1 特征点法 视觉slam主要分为视觉前段和优化后端。前段称为视觉里程计（VO），它根据相邻图象的信息估计出粗略的相机运动，给后端提供较好的初始值。 VO的实现方法可以根据是否需要提取特征分为两类：基于特征点的方法，不使用特征点的直接方法。 基于特征点的VO运行稳定，对光照、动态物体不敏感。1.1 特征点 为了能够更好的进行图像匹配，需要在图像中选择具有代表性的区域，例如：图像中的角点、边缘和一些">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190623231619397.jpg?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190623232028447.jpg?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190623232040943.jpg?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190625165200724.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190909185144366.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:updated_time" content="2019-11-19T08:15:30.020Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190623231619397.jpg?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="https://xiao-hu.com.cn/2019/05/21/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>视觉slam十四讲   7.视觉里程计1 | xiaohu博客</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaohu博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xiao-hu.com.cn/2019/05/21/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="xiaohu">
      <meta itemprop="description" content="博观而约取,厚积而薄发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaohu博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          视觉slam十四讲   7.视觉里程计1
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-21 16:13:48" itemprop="dateCreated datePublished" datetime="2019-05-21T16:13:48+08:00">2019-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-19 16:15:30" itemprop="dateModified" datetime="2019-11-19T16:15:30+08:00">2019-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/VSLAM/" itemprop="url" rel="index">
                    <span itemprop="name">VSLAM</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>26 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-特征点法"><a href="#1-特征点法" class="headerlink" title="1 特征点法"></a>1 特征点法</h1><ol>
<li>视觉slam主要分为视觉前段和优化后端。前段称为视觉里程计（VO），它根据相邻图象的信息估计出粗略的相机运动，给后端提供较好的初始值。</li>
<li>VO的实现方法可以根据是否需要提取特征分为两类：基于特征点的方法，不使用特征点的直接方法。 基于特征点的VO运行稳定，对光照、动态物体不敏感。<h2 id="1-1-特征点"><a href="#1-1-特征点" class="headerlink" title="1.1 特征点"></a>1.1 特征点</h2></li>
<li>为了能够更好的进行图像匹配，需要在图像中选择具有代表性的区域，例如：图像中的角点、边缘和一些区块。</li>
<li>更为稳定的的局部图像特征特征点，例如：SIFT,SURF,ORB等这些特征点不会随着相机的移动，旋转或者光照的变化而变化，其四个特征:<ul>
<li>可重复性Repeatability<ul>
<li>可区别性Distinctiveness</li>
<li>高效率Efficiency</li>
<li>本地性Locality</li>
</ul>
</li>
</ul>
</li>
<li>特征点由(关键点Key-Point)和描述子（Descriptor）。关键点指的是该特征点在图像中的位置，有些还具有方向、尺度信息；描述子通常是一个向量，按照人为的设计的方式，描述关键点周围像素的信息。通常描述子是按照<strong>外观相似的特征应该有相似的描述子</strong>设计的。</li>
<li>SIFT（Scale Invariant Feature Transform）尺度不变特征变换，SIFT特征对旋转、尺度缩放、亮度变化等保持不变性，是一种非常稳定的局部特征。</li>
<li>SURF（ Speeded Up Robust Features），主要针对SIFT算法运算速度慢，计算量大的缺点进行了改进。</li>
<li>ORB（Oriented FAST and Rotated BRIEF）算法，改进了FAST检测子不具有方向性的问题，并使用速度极快的二进制描述子BRIEF。<h2 id="1-2-ORB特征"><a href="#1-2-ORB特征" class="headerlink" title="1.2 ORB特征"></a>1.2 ORB特征</h2></li>
<li><p>提取ORB（Oriented FAST and  Rotated BRIEF)特征分为两个步骤：</p>
<pre><code> 1. FAST 角点提取：找出图像中的” 角点”。相较于原版的 FAST, ORB 中计算了特征点的主方向，为后续的 BRIEF 描述子增加了旋转不变特性。
</code></pre><ol>
<li>BRIEF 描述子：对前一步提取出特征点的周围图像区域进行描述</li>
</ol>
</li>
<li><p><strong>Fast 角点检测</strong>，FAST 是一种角点，主要检测局部像素灰度变化明显的地方，以速度快著称。其思 想是：如果一个像素与它邻域的像素差别较大（过亮或过暗）, 那它更可能是角点。检测过程如下：</p>
<ol>
<li>在图像中选取像素 $p$，假设它的亮度为 $I_{p}$。</li>
<li>设置一个阈值 $T$(比如$I_{p}$的 20%)。</li>
<li>以像素 $p$为中心, 选取半径为 3 的圆上的 16 个像素点。</li>
<li>假如选取的圆上，有连续的 NNN 个点的亮度大于 $I_{p}+T$或小于$I_{p}+T$，那么像素 $p$可以被认为是特征点 (N通常取 12，即为 FAST-12。其它常用的 $N$ 取值为 9 和 11，他们分别被称为 FAST-9，FAST-11)。</li>
<li>循环以上四步，对每一个像素执行相同的操作。</li>
</ol>
</li>
<li><p>在 ORB 中，对原始的 FAST 算法进行了改进。可以指定最终要提取的角点数量N，对原始 FAST 角点分别计算 Harris 响应值，然后选取前N个具有最大响应值的角点，作为最终的角点集合。</p>
</li>
<li><p>FAST 角点不具有方向信息.针对 FAST 角点不具有方向性和尺度的弱点，ORB 添加了尺度和旋转的描述。</p>
<ul>
<li>尺度不变性由构建图像金字塔（金字塔是指对图像进行不同层次的降采样，以获得不同分辨率的图像），并在金字塔的每一层上检测角点来实现。</li>
<li><p>特征的旋转是由灰度质心法（Intensity Centroid）实现的。</p>
<ol>
<li><p>质心是指以图像块灰度值作为权重的中心。其具体操作步骤如下 ：</p>
<p>  （1）在一个小的图像块 BBB 中，定义图像块的矩为:</p>
<script type="math/tex; mode=display">m _ { p q } = \sum x ^ { p } y ^ { q } I ( x , y ) , \quad p , q = \{ 0,1 \}</script><p> （2）通过矩可以找到图像块的质心：</p>
<script type="math/tex; mode=display">CC = \left( \frac { m _ { 10 } } { m _ { 00 } } , \frac { m _ { 01 } } { m _ { 00 } } \right)</script><p> （3）连接图像块的几何中心 O 与质心 C，得到一个方向向量 $\vec { O C }$，于是特征点的方向可以定义为：</p>
<script type="math/tex; mode=display">\theta = \arctan \left( m _ { 01 } / m _ { 10 } \right)</script></li>
</ol>
</li>
</ul>
</li>
<li><strong>BRIEF 描述子</strong><ol>
<li>BRIEF 是一种二进制描述子，它的描述向量由许多个 0 和 1 组成，这里的 0 和 1 编码了关键点附近两个像素（比如说 p 和q）的大小关系：如果 p 比 q 大，则取 1，反之就取 0。如果我们取了 128 个这样的 p, q，最后就得到 128 维由 0，1 组成的向量。</li>
<li>BRIEF 使用了随机选点的比较，速度非常快，使用了二进制表达，存储起来也十分方便，适用于实时的图像匹配。</li>
<li>ORB 在 FAST 特征点提取阶段计算了关键点的方向，可以利用方向信息，计算了旋转之后的“Steer BRIEF”特征，使 ORB 的描述子具有较好的旋转不变性。<h2 id="1-3-特征匹配"><a href="#1-3-特征匹配" class="headerlink" title="1.3  特征匹配"></a>1.3  特征匹配</h2></li>
</ol>
</li>
<li><strong>暴力匹配</strong>：即对每一个特征点 $x _ { t } ^ { m }$，与所有的$x _ { t +1} ^ { m }$测量描述子的距离，然后排序，取最近的一个作为匹配点。描述子距离表示两个特征之间的相似程度。</li>
<li>浮点类型的描述子，使用<strong>欧氏距离</strong>进行度量即可。</li>
<li>二进制的描述子（比如 BRIEF 这样的），往往使用<strong>汉明距离（</strong>Hamming distance）做为度量——两个二进制串之间的汉明距离，指的是它们不同位数的个数。</li>
<li><strong>快速近似最近邻</strong>（FLANN）：更加适合匹配点数量极多的情况。<h1 id="2-特征提取与匹配"><a href="#2-特征提取与匹配" class="headerlink" title="2 特征提取与匹配"></a>2 特征提取与匹配</h1><strong>代码及注释：</strong><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( argc != <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"usage: feature_extraction img1 img2"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 读取图像</span></span><br><span class="line">    Mat img_1 = imread ( argv[<span class="number">1</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line">    Mat img_2 = imread ( argv[<span class="number">2</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 初始化</span></span><br><span class="line">    <span class="comment">//keypoint是opencv里的数据类型</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">    Mat descriptors_1, descriptors_2;<span class="comment">//描述子</span></span><br><span class="line">    <span class="comment">//opencv3</span></span><br><span class="line">    Ptr&lt;FeatureDetector&gt; detector = ORB::create();<span class="comment">//特征检测器</span></span><br><span class="line">    Ptr&lt;DescriptorExtractor&gt; descriptor = ORB::create();<span class="comment">//描述子提取器</span></span><br><span class="line">    <span class="comment">//opencv2</span></span><br><span class="line">    <span class="comment">// Ptr&lt;FeatureDetector&gt; detector = FeatureDetector::create(detector_name);</span></span><br><span class="line">    <span class="comment">// Ptr&lt;DescriptorExtractor&gt; descriptor = DescriptorExtractor::create(descriptor_name);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">    detector-&gt;detect ( img_1,keypoints_1 );<span class="comment">//固定用法，检测图一中的角点位置</span></span><br><span class="line">    detector-&gt;detect ( img_2,keypoints_2 );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">    <span class="comment">//描述子通常是一个向量，保存在Mat中</span></span><br><span class="line">    descriptor-&gt;compute ( img_1, keypoints_1, descriptors_1 );<span class="comment">//计算图一特征点的描述子</span></span><br><span class="line">    descriptor-&gt;compute ( img_2, keypoints_2, descriptors_2 );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义输出检测特征点的图片</span></span><br><span class="line">    Mat outimg1;</span><br><span class="line">    <span class="comment">//随机像素值</span></span><br><span class="line">    drawKeypoints( img_1, keypoints_1, outimg1, Scalar::all(<span class="number">-1</span>), DrawMatchesFlags::DEFAULT );</span><br><span class="line">    namedWindow(<span class="string">"ORB特征点"</span>, WINDOW_AUTOSIZE );</span><br><span class="line">    imshow(<span class="string">"ORB特征点"</span>,outimg1);</span><br><span class="line">    imwrite(<span class="string">"ORB特征点.jpg"</span>, outimg1);</span><br></pre></td></tr></table></figure>
<img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190623231619397.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"></li>
</ol><a id="more"></a>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配</span></span><br><span class="line"><span class="comment">//使用了opencv中封装后的暴力匹配算法BFMatcher,使用 Hamming 距离</span></span><br><span class="line"><span class="built_in">vector</span>&lt;DMatch&gt; matches;</span><br><span class="line"><span class="comment">//特征匹配算法：汉明距离</span></span><br><span class="line">Ptr&lt;DescriptorMatcher&gt; matcher  = DescriptorMatcher::create ( <span class="string">"BruteForce-Hamming"</span> );<span class="comment">//描述子匹配器</span></span><br><span class="line"><span class="comment">//BFMatcher matcher ( NORM_HAMMING );</span></span><br><span class="line">matcher-&gt;match ( descriptors_1, descriptors_2, matches );</span><br><span class="line"></span><br><span class="line"><span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line"><span class="comment">//上面的匹配结果有大量的错误匹配，需要使用一些机制来过滤掉错误的匹配</span></span><br><span class="line"><span class="comment">//汉明距离小于最小距离的两倍</span></span><br><span class="line"><span class="keyword">double</span> min_dist=<span class="number">10000</span>, max_dist=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//找出所有匹配之间的最小距离和最大距离, 即是最相似的和最不相似的两组点之间的距离</span></span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; descriptors_1.rows; i++ )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">double</span> dist = matches[i].distance;</span><br><span class="line">    <span class="keyword">if</span> ( dist &lt; min_dist ) min_dist = dist;</span><br><span class="line">    <span class="keyword">if</span> ( dist &gt; max_dist ) max_dist = dist;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅供娱乐的写法</span></span><br><span class="line"><span class="comment">//min_dist = min_element( matches.begin(), matches.end(), [](const DMatch&amp; m1, const DMatch&amp; m2) &#123;return m1.distance&lt;m2.distance;&#125; )-&gt;distance;</span></span><br><span class="line"><span class="comment">//max_dist = max_element( matches.begin(), matches.end(), [](const DMatch&amp; m1, const DMatch&amp; m2) &#123;return m1.distance&lt;m2.distance;&#125; )-&gt;distance;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span> ( <span class="string">"-- Max dist : %f \n"</span>, max_dist );</span><br><span class="line"><span class="built_in">printf</span> ( <span class="string">"-- Min dist : %f \n"</span>, min_dist );</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当描述子之间的距离大于两倍的最小距离时,即认为匹配有误.但有时候最小距离会非常小,设置一个经验值30作为下限.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt; good_matches;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; descriptors_1.rows; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( matches[i].distance &lt;= max ( <span class="number">2</span>*min_dist, <span class="number">30.0</span> ) )</span><br><span class="line">        &#123;</span><br><span class="line">            good_matches.push_back ( matches[i] );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第五步:绘制匹配结果</span></span><br><span class="line">    Mat img_match;</span><br><span class="line">    Mat img_goodmatch;</span><br><span class="line">    drawMatches ( img_1, keypoints_1, img_2, keypoints_2, matches, img_match );</span><br><span class="line">    drawMatches ( img_1, keypoints_1, img_2, keypoints_2, good_matches, img_goodmatch );</span><br><span class="line">    </span><br><span class="line">    namedWindow(<span class="string">"所有匹配点对"</span>, WINDOW_AUTOSIZE );</span><br><span class="line">    imshow ( <span class="string">"所有匹配点对"</span>, img_match );</span><br><span class="line">    imwrite(<span class="string">"所有匹配点对.jpg"</span>, img_match);</span><br><span class="line">    namedWindow(<span class="string">"优化后匹配点对"</span>, WINDOW_AUTOSIZE );</span><br><span class="line">    imshow ( <span class="string">"优化后匹配点对"</span>, img_goodmatch );</span><br><span class="line">    imwrite ( <span class="string">"优化后匹配点对.jpg"</span>, img_goodmatch );</span><br><span class="line">    waitKey(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p><strong>所有匹配点对：</strong><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190623232028447.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"><strong>优化后匹配点对：</strong><br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190623232040943.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">根据匹配的点对,估计相机的运动。</p>
<ul>
<li>当相机为单目时,我们只知道 2D 的像素坐标,因而问题是根据两组 2D 点估计运<br>动。该问题用对极几何来解决。</li>
<li>当相机为双目、RGB-D 时,或者我们通过某种方法得到了距离信息,那问题就是根<br>据两组 3D 点估计运动。该问题通常用 ICP 来解决。</li>
<li>如果我们有 3D 点和它们在相机的投影位置,也能估计相机的运动。该问题通过 PnP<br>求解。<h1 id="3-2D-2D：对极几何"><a href="#3-2D-2D：对极几何" class="headerlink" title="3  2D-2D：对极几何"></a>3  2D-2D：对极几何</h1><h2 id="3-1-对极约束"><a href="#3-1-对极约束" class="headerlink" title="3.1 对极约束"></a>3.1 对极约束</h2><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190625165200724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"><br>设第一帧到第二帧的运动为$R,t$,$O_{1},O_{2}$三个点平面为极平面，$e_{1},e_{2}$为极点，$O_{1}O_{2}$称为基线，$l_{1}l_{2}$为极线。</li>
<li>已知：匹配点对p1p1，p2p2的像素坐标。</li>
<li>给定：两张二维图像，二维图像上特征点的匹配关系。</li>
<li>未知：P的三维空间坐标，$I1$到$I2$的变换矩阵($T_{1,2}$，即R,t）。</li>
</ul>
<p><strong>对极约束</strong></p>
<p>设第一帧的坐标系下P的空间位置为：</p>
<script type="math/tex; mode=display">P=[X,Y,Z]^T</script><p>两个像素点$p1，p2$的像素坐标（单位像素）：</p>
<script type="math/tex; mode=display">s_{1}p_{1}=KP, \quad   s_{2}p_{2}=K(RP+t)</script><p>使用齐次坐标：</p>
<script type="math/tex; mode=display">p_{1}=KP, \quad   p_{2}=K(RP+t)</script><p>取：</p>
<script type="math/tex; mode=display">x_{1}=K^{−1}p_{1},\quad x_{2}=K^{−1}p_{2}</script><p>$x_{1},x_{2}$是两个像素点的归一化的坐标，代入上式得：</p>
<script type="math/tex; mode=display">x_{2}=Rx_{1}+t</script><p>两边同时左乘$t$^:</p>
<script type="math/tex; mode=display">t^{\wedge }x_{2}=t^{\wedge }Rx_{1}</script><p>再左乘一个$x^{T}_{2}$,有:</p>
<script type="math/tex; mode=display">x^{T}_{2}t^{\wedge }x_{2}=x^{T}_{2}t^{\wedge }Rx_{1}</script><p>由上式可得：</p>
<script type="math/tex; mode=display">x^{T}_{2}t^{\wedge }Rx_{1}=0</script><p>带入$p_{1}，p_{2}$：</p>
<script type="math/tex; mode=display">p^{T}_{2}K^{-T}t^{\wedge }Rk^{-1}p_{1}</script><p>本质矩阵E,基础矩阵F,简化对极约束：</p>
<script type="math/tex; mode=display">E=t^{\wedge }R,F=K^{-T}EK^{-1},x^{T}_{2}t^{\wedge }Ex_{1}=p^{T}
_{2}Fp_{1}=0</script><p>对极约束简化给出两个点的空间位置关系，相机位姿估计问题变成一下两部：</p>
<ol>
<li>根据匹配点的位置，求出E或者F。</li>
<li>根据E或者F，求出R,t。<h2 id="3-2-本质矩阵"><a href="#3-2-本质矩阵" class="headerlink" title="3.2 本质矩阵"></a>3.2 本质矩阵</h2>本质矩阵$E=t^{\wedge }R$,3x3矩阵<ul>
<li>E在不同尺度下等价的</li>
</ul>
</li>
</ol>
<ul>
<li>本质矩阵的内在性质：E的奇异值必定为$\left [ \sigma ,\sigma ,0 \right ]$的形式，</li>
<li>由平移和旋转定义，共有3+3=6个自由度，因为对极约束，E具有尺度等价性，自由度-1，共五个。</li>
</ul>
<p><strong>八点法</strong><br>根据对极约束，最少五对点就能求出来E，为了方便，一般使用八对点。</p>
<h2 id="3-3-单应矩阵"><a href="#3-3-单应矩阵" class="headerlink" title="3.3 单应矩阵"></a>3.3 单应矩阵</h2><p>它描述的是两个平面之间的映射关系，如果场景中的特征点都落在同一平面上(比如情面、地面)，则可以通过单应性进行运动估计。<br>假设特征点落在平面P上</p>
<script type="math/tex; mode=display">n^{T}P+d=0</script><script type="math/tex; mode=display">-\frac{n^{T}P}{d} =1</script><script type="math/tex; mode=display">p_{2}=K(RP+t)</script><p>得到一个从图像坐标p1p1到p2p2之间的变换:</p>
<script type="math/tex; mode=display">p_{2}=K(R−\frac{tn^T}{d})K^−1p_{1}</script><p>把中间部分记为H,于是:</p>
<pre><code>                      $$p_{2}=Hp_{1}$$
 **它的定义与平移、旋转和平面的参数相关。**
  把H矩阵看成向量，通过求解该向量的线性方程来恢复H,又称直线线性变换法(Direct Linear Transform)
  与求解本质矩阵类似，求出来后需要对其进行分解才能得到R,t,分解方法有数值法和解析法。分解同样得到四组解，最后根据先验信息进行排除得到唯一的一组R,t解。
</code></pre><p>为了避免退化现象造成的影响，通常会同时估计基础矩阵F和单应矩阵H，选择重投影误差比较小的那个最终的运动估计矩阵。</p>
<h2 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h2><p>由于 E 本身具有尺度等价性,它分解得到的 t, R 也有一个尺度等价性。通常把 t 进行归一化,让它的<br>长度等于 1。</p>
<ol>
<li><p>尺度不确定性<br>==对t长度的归一化，直接导致单目视觉的尺度不确定性(Scale Ambiguity)==,在单目视觉中对两张图像的t归一化相当于固定了制度，我们不知道长度是多少，==以这时t的单位是1，计算相机运动和特征点的3D的位置，称为单目视觉SLAM的初始化。==</p>
</li>
<li><p>初始化的纯旋转问题<br>==单目视觉初始化不能只有纯旋转，必须要有一定程度的平移==。如果没有平移，从E分解到R,t的过程中，导致t为零，那么得到的E也为零，这将导致无法求解R。不过此时可以依靠H求取旋转，但是仅有旋转时，无法使用三角测量估计特征点的空间位置。<br><strong>单目初始化不能只有纯旋转，必须有一定程度的平移</strong></p>
</li>
<li><p>对于8对点的情况<br>当给定匹配点多余8个的时候，比如算出79对匹配点，使用一个最小二乘计算：</p>
<script type="math/tex; mode=display">\min_{e}\left \| Ae \right \|_{2}^{2}=\min e^{T}A^TAe</script></li>
</ol>
<p>不过在存在错误匹配的情况下使用<strong>随机抽样一致算法</strong>(Random Sample Concensus,<strong>RANSAC</strong>)，可以处理带有错误匹配的数据。</p>
<h1 id="4-实践：对极约束求相机运动"><a href="#4-实践：对极约束求相机运动" class="headerlink" title="4 实践：对极约束求相机运动"></a>4 实践：对极约束求相机运动</h1><p><strong>代码及注释：</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/features2d/features2d.hpp&gt;//Features2D， 2D功能框架</span></span></span><br><span class="line"><span class="comment">//高层GUI图形用户界面，包含媒体的I / O输入输出，视频捕捉、图像和视频的编码解码、图形交互界面的接口等内容</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/calib3d/calib3d.hpp&gt;//主要是相机校准和三维重建相关的内容</span></span></span><br><span class="line"><span class="comment">// #include "extra.h" // use this if in OpenCV2 </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************************</span></span><br><span class="line"><span class="comment"> * 本程序演示了如何使用2D-2D的特征匹配估计相机运动</span></span><br><span class="line"><span class="comment"> * **************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">find_feature_matches</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Mat&amp; img_1, <span class="keyword">const</span> Mat&amp; img_2,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt;&amp; keypoints_1,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt;&amp; keypoints_2,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt;&amp; matches )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pose_estimation_2d2d</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt; matches,</span></span></span><br><span class="line"><span class="function"><span class="params">    Mat&amp; R, Mat&amp; t )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 像素坐标转相机归一化坐标</span></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span> <span class="params">( <span class="keyword">const</span> Point2d&amp; p, <span class="keyword">const</span> Mat&amp; K )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( argc != <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"usage: pose_estimation_2d2d img1 img2"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-- 读取图像</span></span><br><span class="line">    Mat img_1 = imread ( argv[<span class="number">1</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line">    Mat img_2 = imread ( argv[<span class="number">2</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">    <span class="built_in">vector</span>&lt;DMatch&gt; matches;</span><br><span class="line">    find_feature_matches ( img_1, img_2, keypoints_1, keypoints_2, matches );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"一共找到了"</span>&lt;&lt;matches.size() &lt;&lt;<span class="string">"组匹配点"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 估计两张图像间运动</span></span><br><span class="line">    Mat R,t;</span><br><span class="line">    pose_estimation_2d2d ( keypoints_1, keypoints_2, matches, R, t );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 验证E=t^R*scale</span></span><br><span class="line">    Mat t_x = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt;</span><br><span class="line">                <span class="number">0</span>,                      -t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">0</span> ),     t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">0</span> ),</span><br><span class="line">                t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">0</span> ),      <span class="number">0</span>,                      -t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ),</span><br><span class="line">                -t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">0</span> ),     t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ),      <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"t^R="</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;t_x*R&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 验证对极约束</span></span><br><span class="line">    Mat K = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">for</span> ( DMatch m: matches )</span><br><span class="line">    &#123;</span><br><span class="line">        Point2d pt1 = pixel2cam ( keypoints_1[ m.queryIdx ].pt, K );</span><br><span class="line">        Mat y1 = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">1</span> ) &lt;&lt; pt1.x, pt1.y, <span class="number">1</span> );</span><br><span class="line">        Point2d pt2 = pixel2cam ( keypoints_2[ m.trainIdx ].pt, K );</span><br><span class="line">        Mat y2 = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">1</span> ) &lt;&lt; pt2.x, pt2.y, <span class="number">1</span> );</span><br><span class="line">        Mat d = y2.t() * t_x * R * y1;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"epipolar constraint = "</span> &lt;&lt; d &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>find_feature_matches 定义</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">find_feature_matches</span> <span class="params">( <span class="keyword">const</span> Mat&amp; img_1, <span class="keyword">const</span> Mat&amp; img_2,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt;&amp; keypoints_1,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt;&amp; keypoints_2,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt;&amp; matches )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//-- 初始化</span></span><br><span class="line">    Mat descriptors_1, descriptors_2;</span><br><span class="line">    <span class="comment">// used in OpenCV3 </span></span><br><span class="line">    Ptr&lt;FeatureDetector&gt; detector = ORB::create();</span><br><span class="line">    Ptr&lt;DescriptorExtractor&gt; descriptor = ORB::create();</span><br><span class="line">    <span class="comment">// use this if you are in OpenCV2 </span></span><br><span class="line">    <span class="comment">// Ptr&lt;FeatureDetector&gt; detector = FeatureDetector::create ( "ORB" );</span></span><br><span class="line">    <span class="comment">// Ptr&lt;DescriptorExtractor&gt; descriptor = DescriptorExtractor::create ( "ORB" );</span></span><br><span class="line">    Ptr&lt;DescriptorMatcher&gt; matcher  = DescriptorMatcher::create ( <span class="string">"BruteForce-Hamming"</span> );</span><br><span class="line">    <span class="comment">//-- 第一步:检测 Oriented FAST 角点位置</span></span><br><span class="line">    detector-&gt;detect ( img_1,keypoints_1 );</span><br><span class="line">    detector-&gt;detect ( img_2,keypoints_2 );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第二步:根据角点位置计算 BRIEF 描述子</span></span><br><span class="line">    descriptor-&gt;compute ( img_1, keypoints_1, descriptors_1 );</span><br><span class="line">    descriptor-&gt;compute ( img_2, keypoints_2, descriptors_2 );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第三步:对两幅图像中的BRIEF描述子进行匹配，使用 Hamming 距离</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;DMatch&gt; match;</span><br><span class="line">    <span class="comment">//BFMatcher matcher ( NORM_HAMMING );</span></span><br><span class="line">    matcher-&gt;match ( descriptors_1, descriptors_2, match );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 第四步:匹配点对筛选</span></span><br><span class="line">    <span class="keyword">double</span> min_dist=<span class="number">10000</span>, max_dist=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//找出所有匹配之间的最小距离和最大距离, 即是最相似的和最不相似的两组点之间的距离</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; descriptors_1.rows; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">double</span> dist = match[i].distance;</span><br><span class="line">        <span class="keyword">if</span> ( dist &lt; min_dist ) min_dist = dist;</span><br><span class="line">        <span class="keyword">if</span> ( dist &gt; max_dist ) max_dist = dist;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span> ( <span class="string">"-- Max dist : %f \n"</span>, max_dist );</span><br><span class="line">    <span class="built_in">printf</span> ( <span class="string">"-- Min dist : %f \n"</span>, min_dist );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当描述子之间的距离大于两倍的最小距离时,即认为匹配有误.但有时候最小距离会非常小,设置一个经验值30作为下限.</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; descriptors_1.rows; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( match[i].distance &lt;= max ( <span class="number">2</span>*min_dist, <span class="number">30.0</span> ) )</span><br><span class="line">        &#123;</span><br><span class="line">            matches.push_back ( match[i] );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 像素坐标转相机归一化坐标</span></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span> <span class="params">( <span class="keyword">const</span> Point2d&amp; p, <span class="keyword">const</span> Mat&amp; K )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Point2d</span><br><span class="line">           (</span><br><span class="line">               ( p.x - K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">2</span> ) ) / K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ),</span><br><span class="line">               ( p.y - K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">2</span> ) ) / K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">1</span> )</span><br><span class="line">           );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>pose_estimation_2d2d 定义</strong><br>从特征点(keypoints)和匹配关系（matches）求解位姿(R,t)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pose_estimation_2d2d</span> <span class="params">( <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_2,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt; matches,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Mat&amp; R, Mat&amp; t )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 相机内参,TUM Freiburg2</span></span><br><span class="line">    Mat K = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 把匹配点转换为vector&lt;Point2f&gt;的形式</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Point2f&gt; points1;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Point2f&gt; points2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ( <span class="keyword">int</span> ) matches.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        points1.push_back ( keypoints_1[matches[i].queryIdx].pt );</span><br><span class="line">        <span class="comment">//queryIdx为query描述子的索引,match函数中前面的那个描述子 </span></span><br><span class="line">        points2.push_back ( keypoints_2[matches[i].trainIdx].pt );</span><br><span class="line">        <span class="comment">//trainIdx为train描述子的索引,match函数中后面的那个描述子 </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 计算基础矩阵</span></span><br><span class="line">    Mat fundamental_matrix;</span><br><span class="line">    fundamental_matrix = findFundamentalMat ( points1, points2, CV_FM_8POINT );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"fundamental_matrix is "</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt; fundamental_matrix&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 计算本质矩阵</span></span><br><span class="line">    <span class="function">Point2d <span class="title">principal_point</span> <span class="params">( <span class="number">325.1</span>, <span class="number">249.7</span> )</span></span>;	<span class="comment">//相机光心, TUM dataset标定值</span></span><br><span class="line">    <span class="keyword">double</span> focal_length = <span class="number">521</span>;			<span class="comment">//相机焦距, TUM dataset标定值</span></span><br><span class="line">    Mat essential_matrix;</span><br><span class="line">    essential_matrix = findEssentialMat ( points1, points2, focal_length, principal_point );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"essential_matrix is "</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt; essential_matrix&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 计算单应矩阵</span></span><br><span class="line">    Mat homography_matrix;</span><br><span class="line">    homography_matrix = findHomography ( points1, points2, RANSAC, <span class="number">3</span> );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"homography_matrix is "</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;homography_matrix&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 从本质矩阵中恢复旋转和平移信息.</span></span><br><span class="line">    recoverPose ( essential_matrix, points1, points2, R, t, focal_length, principal_point );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"R is "</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;R&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"t is "</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;t&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>pixel2cam 定义</strong><br>像素坐标转相机归一化坐标<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">Point2d <span class="title">pixel2cam</span> <span class="params">( <span class="keyword">const</span> Point2d&amp; p, <span class="keyword">const</span> Mat&amp; K )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Point2d</span><br><span class="line">           (</span><br><span class="line">               ( p.x - K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">2</span> ) ) / K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ),</span><br><span class="line">               ( p.y - K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">2</span> ) ) / K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">1</span> )</span><br><span class="line">           );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>运行结果：</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[ INFO:<span class="number">0</span>] Initialize OpenCL runtime...</span><br><span class="line">-- Max dist : <span class="number">95.000000</span> </span><br><span class="line">-- Min dist : <span class="number">7.000000</span> </span><br><span class="line">一共找到了<span class="number">81</span>组匹配点</span><br><span class="line">fundamental_matrix is </span><br><span class="line">[<span class="number">5.435453065936354e-06</span>, <span class="number">0.0001366043242989653</span>, <span class="number">-0.02140890086948144</span>;</span><br><span class="line"> <span class="number">-0.0001321142229824715</span>, <span class="number">2.339475702778067e-05</span>, <span class="number">-0.006332906454396007</span>;</span><br><span class="line"> <span class="number">0.02107630352202796</span>, <span class="number">-0.003666833952953114</span>, <span class="number">0.9999999999999999</span>]</span><br><span class="line">essential_matrix is </span><br><span class="line">[<span class="number">0.01724015832721706</span>, <span class="number">0.328054335794133</span>, <span class="number">0.0473747783144249</span>;</span><br><span class="line"> <span class="number">-0.3243229585962962</span>, <span class="number">0.03292958445202408</span>, <span class="number">-0.6262554366073018</span>;</span><br><span class="line"> <span class="number">-0.005885857752320116</span>, <span class="number">0.6253830041920333</span>, <span class="number">0.0153167864909267</span>]</span><br><span class="line">homography_matrix is </span><br><span class="line">[<span class="number">0.9131751791807657</span>, <span class="number">-0.1092435315823255</span>, <span class="number">29.95860009984688</span>;</span><br><span class="line"> <span class="number">0.02223560352312278</span>, <span class="number">0.9826008005062553</span>, <span class="number">6.508910839573075</span>;</span><br><span class="line"> <span class="number">-0.0001001560381022834</span>, <span class="number">0.000103777943639824</span>, <span class="number">0.9999999999999999</span>]</span><br><span class="line">R is </span><br><span class="line">[<span class="number">0.9985534106102478</span>, <span class="number">-0.05339308467584758</span>, <span class="number">0.006345444621108698</span>;</span><br><span class="line"> <span class="number">0.05321959721496264</span>, <span class="number">0.9982715997131746</span>, <span class="number">0.02492965459802003</span>;</span><br><span class="line"> <span class="number">-0.007665548311697523</span>, <span class="number">-0.02455588961730239</span>, <span class="number">0.9996690690694516</span>]</span><br><span class="line">t is </span><br><span class="line">[<span class="number">-0.8829934995085544</span>;</span><br><span class="line"> <span class="number">-0.05539655431450562</span>;</span><br><span class="line"> <span class="number">0.4661048182498402</span>]</span><br><span class="line">t^R=</span><br><span class="line">[<span class="number">-0.02438126572381045</span>, <span class="number">-0.4639388908753606</span>, <span class="number">-0.06699805400667856</span>;</span><br><span class="line"> <span class="number">0.4586619266358499</span>, <span class="number">-0.04656946493536188</span>, <span class="number">0.8856589319599302</span>;</span><br><span class="line"> <span class="number">0.008323859859529846</span>, <span class="number">-0.8844251262060034</span>, <span class="number">-0.0216612071874423</span>]</span><br><span class="line">epipolar constraint = [<span class="number">0.004334754136721797</span>]</span><br><span class="line">epipolar constraint = [<span class="number">-0.0002809243685121809</span>]</span><br><span class="line">......</span><br><span class="line">epipolar constraint = [<span class="number">-0.004259380631293275</span>]</span><br><span class="line">epipolar constraint = [<span class="number">-0.0007738612238716719</span>]</span><br></pre></td></tr></table></figure></p>
<h1 id="5-三角测量"><a href="#5-三角测量" class="headerlink" title="5 三角测量"></a>5 三角测量</h1><h1 id="6-实践：三角测量"><a href="#6-实践：三角测量" class="headerlink" title="6 实践：三角测量"></a>6 实践：三角测量</h1><p>单目SLAM(2d-2d)中，使用对极约束估计R,tR,t，使用三角测量估计深度<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">triangulation</span> <span class="params">( </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt; KeyPoint &gt;&amp; keypoint_1, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt; KeyPoint &gt;&amp; keypoint_2, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; DMatch &gt;&amp; matches,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Mat&amp; R, <span class="keyword">const</span> Mat&amp; t, </span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">vector</span>&lt; Point3d &gt;&amp; points )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mat T1 = (Mat_&lt;<span class="keyword">float</span>&gt; (<span class="number">3</span>,<span class="number">4</span>) &lt;&lt;</span><br><span class="line">        <span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    Mat T2 = (Mat_&lt;<span class="keyword">float</span>&gt; (<span class="number">3</span>,<span class="number">4</span>) &lt;&lt;</span><br><span class="line">        R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>,<span class="number">0</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>,<span class="number">1</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>,<span class="number">2</span>), t.at&lt;<span class="keyword">double</span>&gt;(<span class="number">0</span>,<span class="number">0</span>),</span><br><span class="line">        R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>,<span class="number">0</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>,<span class="number">1</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>,<span class="number">2</span>), t.at&lt;<span class="keyword">double</span>&gt;(<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">        R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">2</span>,<span class="number">0</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">2</span>,<span class="number">1</span>), R.at&lt;<span class="keyword">double</span>&gt;(<span class="number">2</span>,<span class="number">2</span>), t.at&lt;<span class="keyword">double</span>&gt;(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    Mat K = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">    <span class="built_in">vector</span>&lt;Point2f&gt; pts_1, pts_2;</span><br><span class="line">    <span class="keyword">for</span> ( DMatch m:matches )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将像素坐标转换至相机坐标</span></span><br><span class="line">        pts_1.push_back ( pixel2cam( keypoint_1[m.queryIdx].pt, K) );</span><br><span class="line">        pts_2.push_back ( pixel2cam( keypoint_2[m.trainIdx].pt, K) );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Mat pts_4d;</span><br><span class="line">    cv::triangulatePoints( T1, T2, pts_1, pts_2, pts_4d );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 转换成非齐次坐标</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;pts_4d.cols; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        Mat x = pts_4d.col(i);</span><br><span class="line">        x /= x.at&lt;<span class="keyword">float</span>&gt;(<span class="number">3</span>,<span class="number">0</span>); <span class="comment">// 归一化</span></span><br><span class="line">        <span class="function">Point3d <span class="title">p</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            x.at&lt;<span class="keyword">float</span>&gt;(<span class="number">0</span>,<span class="number">0</span>), </span></span></span><br><span class="line"><span class="function"><span class="params">            x.at&lt;<span class="keyword">float</span>&gt;(<span class="number">1</span>,<span class="number">0</span>), </span></span></span><br><span class="line"><span class="function"><span class="params">            x.at&lt;<span class="keyword">float</span>&gt;(<span class="number">2</span>,<span class="number">0</span>) </span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line">        points.push_back( p );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( argc != <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"usage: triangulation img1 img2"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-- 读取图像</span></span><br><span class="line">    Mat img_1 = imread ( argv[<span class="number">1</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line">    Mat img_2 = imread ( argv[<span class="number">2</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">    <span class="built_in">vector</span>&lt;DMatch&gt; matches;</span><br><span class="line">    find_feature_matches ( img_1, img_2, keypoints_1, keypoints_2, matches );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"一共找到了"</span>&lt;&lt;matches.size() &lt;&lt;<span class="string">"组匹配点"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 估计两张图像间运动</span></span><br><span class="line">    Mat R,t;</span><br><span class="line">    pose_estimation_2d2d ( keypoints_1, keypoints_2, matches, R, t );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//-- 三角化</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Point3d&gt; points;</span><br><span class="line">    triangulation( keypoints_1, keypoints_2, matches, R, t, points );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//-- 验证三角化点与特征点的重投影关系</span></span><br><span class="line">    Mat K = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;matches.size(); i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        Point2d pt1_cam = pixel2cam( keypoints_1[ matches[i].queryIdx ].pt, K );</span><br><span class="line">        <span class="function">Point2d <span class="title">pt1_cam_3d</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            points[i].x/points[i].z, </span></span></span><br><span class="line"><span class="function"><span class="params">            points[i].y/points[i].z </span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"point in the first camera frame: "</span>&lt;&lt;pt1_cam&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"point projected from 3D "</span>&lt;&lt;pt1_cam_3d&lt;&lt;<span class="string">", d="</span>&lt;&lt;points[i].z&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第二个图</span></span><br><span class="line">        Point2f pt2_cam = pixel2cam( keypoints_2[ matches[i].trainIdx ].pt, K );</span><br><span class="line">        Mat pt2_trans = R*( Mat_&lt;<span class="keyword">double</span>&gt;(<span class="number">3</span>,<span class="number">1</span>) &lt;&lt; points[i].x, points[i].y, points[i].z ) + t;</span><br><span class="line">        pt2_trans /= pt2_trans.at&lt;<span class="keyword">double</span>&gt;(<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"point in the second camera frame: "</span>&lt;&lt;pt2_cam&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"point reprojected from second frame: "</span>&lt;&lt;pt2_trans.t()&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="7-3D-2D-PnP"><a href="#7-3D-2D-PnP" class="headerlink" title="7 3D-2D:PnP"></a>7 3D-2D:PnP</h1><ul>
<li>PnP(Perspective-n-Point)是求解 3D 到 2D 点对运动的方法。最少只需三个点对(需要至少一个额外点验证结果)就可以估计相机运动。</li>
<li>PnP 问题有很多种求解方法,例如用三对点估计位姿的 P3P,直接线性变换(DLT),EPnP(Efficient PnP),UPnP等等)。此外,还能用非线性优化的方式,构建最小二乘问题并迭代求解,也就是万金油式的 Bundle Adjustment。<h2 id="7-1-直接线性变换"><a href="#7-1-直接线性变换" class="headerlink" title="7.1 直接线性变换"></a>7.1 直接线性变换</h2><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190909185144366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"><h2 id="7-2-P3P"><a href="#7-2-P3P" class="headerlink" title="7.2 P3P"></a>7.2 P3P</h2><h2 id="7-3-Bundle-Adjustment"><a href="#7-3-Bundle-Adjustment" class="headerlink" title="7.3 Bundle Adjustment"></a>7.3 Bundle Adjustment</h2><h1 id="8-实践：求解PnP"><a href="#8-实践：求解PnP" class="headerlink" title="8 实践：求解PnP"></a>8 实践：求解PnP</h1><h2 id="8-1-使用EPnP求解位姿"><a href="#8-1-使用EPnP求解位姿" class="headerlink" title="8.1 使用EPnP求解位姿"></a>8.1 使用EPnP求解位姿</h2></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( argc != <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"usage: pose_estimation_3d2d img1 img2 depth1 depth2"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//-- 读取图像</span></span><br><span class="line">    Mat img_1 = imread ( argv[<span class="number">1</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line">    Mat img_2 = imread ( argv[<span class="number">2</span>], CV_LOAD_IMAGE_COLOR );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;KeyPoint&gt; keypoints_1, keypoints_2;</span><br><span class="line">    <span class="built_in">vector</span>&lt;DMatch&gt; matches;</span><br><span class="line">    find_feature_matches ( img_1, img_2, keypoints_1, keypoints_2, matches );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"一共找到了"</span>&lt;&lt;matches.size() &lt;&lt;<span class="string">"组匹配点"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立3D点</span></span><br><span class="line">    Mat d1 = imread ( argv[<span class="number">3</span>], CV_LOAD_IMAGE_UNCHANGED );       <span class="comment">// 深度图为16位无符号数，单通道图像</span></span><br><span class="line">    Mat K = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt; <span class="number">520.9</span>, <span class="number">0</span>, <span class="number">325.1</span>, <span class="number">0</span>, <span class="number">521.0</span>, <span class="number">249.7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span> );</span><br><span class="line">    <span class="built_in">vector</span>&lt;Point3f&gt; pts_3d;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Point2f&gt; pts_2d;</span><br><span class="line">    <span class="keyword">for</span> ( DMatch m:matches )</span><br><span class="line">    &#123;</span><br><span class="line">        ushort d = d1.ptr&lt;<span class="keyword">unsigned</span> <span class="keyword">short</span>&gt; (<span class="keyword">int</span> ( keypoints_1[m.queryIdx].pt.y )) [ <span class="keyword">int</span> ( keypoints_1[m.queryIdx].pt.x ) ];</span><br><span class="line">        <span class="keyword">if</span> ( d == <span class="number">0</span> )   <span class="comment">// bad depth</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">float</span> dd = d/<span class="number">5000.0</span>;</span><br><span class="line">        Point2d p1 = pixel2cam ( keypoints_1[m.queryIdx].pt, K );</span><br><span class="line">        pts_3d.push_back ( Point3f ( p1.x*dd, p1.y*dd, dd ) );</span><br><span class="line">        pts_2d.push_back ( keypoints_2[m.trainIdx].pt );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"3d-2d pairs: "</span>&lt;&lt;pts_3d.size() &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    Mat r, t;</span><br><span class="line">    solvePnP ( pts_3d, pts_2d, K, Mat(), r, t, <span class="literal">false</span> ); <span class="comment">// 调用OpenCV 的 PnP 求解，可选择EPNP，DLS等方法</span></span><br><span class="line">    Mat R;</span><br><span class="line">    cv::Rodrigues ( r, R ); <span class="comment">// r为旋转向量形式，用Rodrigues公式转换为矩阵</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"R="</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;R&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"t="</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;t&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"calling bundle adjustment"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    bundleAdjustment ( pts_3d, pts_2d, K, R, t );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-- Max dist : <span class="number">95.000000</span> </span><br><span class="line">-- Min dist : <span class="number">7.000000</span> </span><br><span class="line">一共找到了<span class="number">81</span>组匹配点</span><br><span class="line"><span class="number">3</span>d<span class="number">-2</span>d pairs: <span class="number">77</span></span><br><span class="line">R=</span><br><span class="line">[<span class="number">0.9979193252225089</span>, <span class="number">-0.05138618904650331</span>, <span class="number">0.03894200717386666</span>;</span><br><span class="line"> <span class="number">0.05033852907733834</span>, <span class="number">0.9983556574295412</span>, <span class="number">0.02742286944793203</span>;</span><br><span class="line"> <span class="number">-0.04028712992734059</span>, <span class="number">-0.02540552801469367</span>, <span class="number">0.9988651091656532</span>]</span><br><span class="line">t=</span><br><span class="line">[<span class="number">-0.1255867099750398</span>;</span><br><span class="line"> <span class="number">-0.007363525258777434</span>;</span><br><span class="line"> <span class="number">0.06099926588678889</span>]</span><br></pre></td></tr></table></figure></p>
<h2 id="8-2-使用BA优化"><a href="#8-2-使用BA优化" class="headerlink" title="8.2 使用BA优化"></a>8.2 使用BA优化</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bundleAdjustment</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt; Point3f &gt; points_3d,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt; Point2f &gt; points_2d,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Mat&amp; K,</span></span></span><br><span class="line"><span class="function"><span class="params">    Mat&amp; R, Mat&amp; t )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化g2o</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::BlockSolver&lt; g2o::BlockSolverTraits&lt;<span class="number">6</span>,<span class="number">3</span>&gt; &gt; Block;  <span class="comment">// pose 维度为 6, landmark 维度为 3</span></span><br><span class="line">    Block::LinearSolverType* linearSolver = <span class="keyword">new</span> g2o::LinearSolverCSparse&lt;Block::PoseMatrixType&gt;(); <span class="comment">// 线性方程求解器</span></span><br><span class="line">    Block* solver_ptr = <span class="keyword">new</span> Block ( linearSolver );     <span class="comment">// 矩阵块求解器</span></span><br><span class="line">    g2o::OptimizationAlgorithmLevenberg* solver = <span class="keyword">new</span> g2o::OptimizationAlgorithmLevenberg ( solver_ptr );</span><br><span class="line">    g2o::SparseOptimizer optimizer;</span><br><span class="line">    optimizer.setAlgorithm ( solver );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// vertex</span></span><br><span class="line">    g2o::VertexSE3Expmap* pose = <span class="keyword">new</span> g2o::VertexSE3Expmap(); <span class="comment">// camera pose</span></span><br><span class="line">    Eigen::Matrix3d R_mat;</span><br><span class="line">    R_mat &lt;&lt;</span><br><span class="line">          R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">1</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">2</span> ),</span><br><span class="line">               R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">0</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">1</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">2</span> ),</span><br><span class="line">               R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">0</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">1</span> ), R.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">2</span> );</span><br><span class="line">    pose-&gt;setId ( <span class="number">0</span> );</span><br><span class="line">    pose-&gt;setEstimate ( g2o::SE3Quat (</span><br><span class="line">                            R_mat,</span><br><span class="line">                            Eigen::Vector3d ( t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ), t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">0</span> ), t.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">2</span>,<span class="number">0</span> ) )</span><br><span class="line">                        ) );</span><br><span class="line">    optimizer.addVertex ( pose );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">const</span> Point3f p:points_3d )   <span class="comment">// landmarks</span></span><br><span class="line">    &#123;</span><br><span class="line">        g2o::VertexSBAPointXYZ* point = <span class="keyword">new</span> g2o::VertexSBAPointXYZ();</span><br><span class="line">        point-&gt;setId ( index++ );</span><br><span class="line">        point-&gt;setEstimate ( Eigen::Vector3d ( p.x, p.y, p.z ) );</span><br><span class="line">        point-&gt;setMarginalized ( <span class="literal">true</span> ); <span class="comment">// g2o 中必须设置 marg 参见第十讲内容</span></span><br><span class="line">        optimizer.addVertex ( point );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// parameter: camera intrinsics</span></span><br><span class="line">    g2o::CameraParameters* camera = <span class="keyword">new</span> g2o::CameraParameters (</span><br><span class="line">        K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">0</span> ), Eigen::Vector2d ( K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">0</span>,<span class="number">2</span> ), K.at&lt;<span class="keyword">double</span>&gt; ( <span class="number">1</span>,<span class="number">2</span> ) ), <span class="number">0</span></span><br><span class="line">    );</span><br><span class="line">    camera-&gt;setId ( <span class="number">0</span> );</span><br><span class="line">    optimizer.addParameter ( camera );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// edges</span></span><br><span class="line">    index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">const</span> Point2f p:points_2d )</span><br><span class="line">    &#123;</span><br><span class="line">        g2o::EdgeProjectXYZ2UV* edge = <span class="keyword">new</span> g2o::EdgeProjectXYZ2UV();</span><br><span class="line">        edge-&gt;setId ( index );</span><br><span class="line">        edge-&gt;setVertex ( <span class="number">0</span>, <span class="keyword">dynamic_cast</span>&lt;g2o::VertexSBAPointXYZ*&gt; ( optimizer.vertex ( index ) ) );</span><br><span class="line">        edge-&gt;setVertex ( <span class="number">1</span>, pose );</span><br><span class="line">        edge-&gt;setMeasurement ( Eigen::Vector2d ( p.x, p.y ) );</span><br><span class="line">        edge-&gt;setParameterId ( <span class="number">0</span>,<span class="number">0</span> );</span><br><span class="line">        edge-&gt;setInformation ( Eigen::Matrix2d::Identity() );</span><br><span class="line">        optimizer.addEdge ( edge );</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">    optimizer.setVerbose ( <span class="literal">true</span> );</span><br><span class="line">    optimizer.initializeOptimization();</span><br><span class="line">    optimizer.optimize ( <span class="number">100</span> );</span><br><span class="line">    chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">    chrono::duration&lt;<span class="keyword">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="keyword">double</span>&gt;&gt; ( t2-t1 );</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"optimization costs time: "</span>&lt;&lt;time_used.count() &lt;&lt;<span class="string">" seconds."</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;<span class="string">"after optimization:"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"T="</span>&lt;&lt;<span class="built_in">endl</span>&lt;&lt;Eigen::Isometry3d ( pose-&gt;estimate() ).matrix() &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">calling bundle adjustment</span><br><span class="line">iteration= <span class="number">0</span>	 chi2= <span class="number">0.001292</span>	 time= <span class="number">0.000468135</span>	 cumTime= <span class="number">0.000468135</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">80.003723</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">1</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">2.6183e-05</span>	 cumTime= <span class="number">0.000494318</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">53.335815</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">2</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">2.541e-05</span>	 cumTime= <span class="number">0.000519728</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">35.557210</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">3</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">2.3129e-05</span>	 cumTime= <span class="number">0.000542857</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">23.704807</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">4</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">2.3182e-05</span>	 cumTime= <span class="number">0.000566039</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">15.803205</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">5</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">2.2782e-05</span>	 cumTime= <span class="number">0.000588821</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">10.535470</span>	 levenbergIter= <span class="number">1</span></span><br><span class="line">iteration= <span class="number">6</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">7.2227e-05</span>	 cumTime= <span class="number">0.000661048</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">230150.846755</span>	 levenbergIter= <span class="number">6</span></span><br><span class="line">iteration= <span class="number">7</span>	 chi2= <span class="number">0.000000</span>	 time= <span class="number">5.2096e-05</span>	 cumTime= <span class="number">0.000713144</span>	 edges= <span class="number">77</span>	 schur= <span class="number">1</span>	 lambda= <span class="number">235674467.076671</span>	 levenbergIter= <span class="number">4</span></span><br><span class="line">optimization costs time: <span class="number">0.000928678</span> seconds.</span><br><span class="line"></span><br><span class="line">after optimization:</span><br><span class="line">T=</span><br><span class="line">   <span class="number">0.997841</span>  <span class="number">-0.0518393</span>   <span class="number">0.0403291</span>   <span class="number">-0.127516</span></span><br><span class="line">  <span class="number">0.0507013</span>      <span class="number">0.9983</span>    <span class="number">0.028745</span> <span class="number">-0.00947167</span></span><br><span class="line"> <span class="number">-0.0417507</span>  <span class="number">-0.0266382</span>    <span class="number">0.998773</span>   <span class="number">0.0595037</span></span><br><span class="line">          <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h1 id="9-3D-3D-ICP"><a href="#9-3D-3D-ICP" class="headerlink" title="9 3D-3D:ICP"></a>9 3D-3D:ICP</h1><p>迭代最近点ICP（ Iterative Closest Point） ，指代匹配好的两组点云间运动估计问题。求解 3D坐标 到 3D坐标的转换矩阵(不用求解距离 激光SLAM 以及 RGB-D SLAM)</p>
<h2 id="9-1-SVD方法"><a href="#9-1-SVD方法" class="headerlink" title="9.1 SVD方法"></a>9.1 SVD方法</h2><p>先定义第i对点的误差项：</p>
<script type="math/tex; mode=display">e_{i}=p_{i}-(Rp^{'}_{i}+t)</script><p>然后，构建最小二乘问题，求使误差平方和达到极小的R,t:</p>
<script type="math/tex; mode=display">\min_{R,t}=\frac{1}{2}\sum_{1}^{n}\left \| \left ( p_{i} -\left ( Rp^{'}_{i}+t \right )\right ) \right \|\tfrac{2}{2}</script><h2 id="9-2-非线性优化方法"><a href="#9-2-非线性优化方法" class="headerlink" title="9.2 非线性优化方法"></a>9.2 非线性优化方法</h2><script type="math/tex; mode=display">\min_{\xi}=\frac{1}{2}\sum_{i=1}^{n}\left \| (p_{i}-exp\left ( \xi ^{\wedge } \right )) p_{i}^{'}\right
 \|\tfrac{2}{2}$$代数扰动模型：
 $$\frac{\partial e}{\partial \delta \xi }=-\left ( exp\left ( \xi ^{\wedge }  \right )p^{'}_{i} \right )^{\bigodot }</script><p> 在非线性优化中，只需要不断的迭代，就能找到极小值<br> 这里ICP指已由图像特征给定了匹配的情况下进行位姿估计的问题。在匹配已知情况下，最小二乘解具有解析解，没必要进行迭代优化<br> 在RGB-D SLAM中，由于一个像素的深度数据可能测不到，可以混合使用PnP和ICP优化：</p>
<ol>
<li>对深度已知的特征点，建模3D-3D误差。</li>
<li>对于深度未知的特征点，建模3D-2D的重投影误差<h1 id="10-实践：求解ICP"><a href="#10-实践：求解ICP" class="headerlink" title="10 实践：求解ICP"></a>10 实践：求解ICP</h1><h2 id="10-1-SVD方法"><a href="#10-1-SVD方法" class="headerlink" title="10.1 SVD方法"></a>10.1 SVD方法</h2></li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pose_estimation_3d3d</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Point3f&gt;&amp; pts1,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Point3f&gt;&amp; pts2,</span></span></span><br><span class="line"><span class="function"><span class="params">    Mat&amp; R, Mat&amp; t</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Point3f p1, p2;     <span class="comment">// center of mass</span></span><br><span class="line">    <span class="keyword">int</span> N = pts1.size();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        p1 += pts1[i];</span><br><span class="line">        p2 += pts2[i];</span><br><span class="line">    &#125;</span><br><span class="line">    p1 = Point3f( Vec3f(p1) /  N);</span><br><span class="line">    p2 = Point3f( Vec3f(p2) / N);</span><br><span class="line">    <span class="built_in">vector</span>&lt;Point3f&gt;     q1 ( N ), q2 ( N ); <span class="comment">// remove the center</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        q1[i] = pts1[i] - p1;</span><br><span class="line">        q2[i] = pts2[i] - p2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// compute q1*q2^T</span></span><br><span class="line">    Eigen::Matrix3d W = Eigen::Matrix3d::Zero();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++ )</span><br><span class="line">    &#123;</span><br><span class="line">        W += Eigen::Vector3d ( q1[i].x, q1[i].y, q1[i].z ) * Eigen::Vector3d ( q2[i].x, q2[i].y, q2[i].z ).transpose();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"W="</span>&lt;&lt;W&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SVD on W</span></span><br><span class="line">    Eigen::JacobiSVD&lt;Eigen::Matrix3d&gt; svd ( W, Eigen::ComputeFullU|Eigen::ComputeFullV );</span><br><span class="line">    Eigen::Matrix3d U = svd.matrixU();</span><br><span class="line">    Eigen::Matrix3d V = svd.matrixV();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (U.determinant() * V.determinant() &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="number">3</span>; ++x)</span><br><span class="line">        &#123;</span><br><span class="line">            U(x, <span class="number">2</span>) *= <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"U="</span>&lt;&lt;U&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"V="</span>&lt;&lt;V&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    Eigen::Matrix3d R_ = U* ( V.transpose() );</span><br><span class="line">    Eigen::Vector3d t_ = Eigen::Vector3d ( p1.x, p1.y, p1.z ) - R_ * Eigen::Vector3d ( p2.x, p2.y, p2.z );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convert to cv::Mat</span></span><br><span class="line">    R = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">3</span> ) &lt;&lt;</span><br><span class="line">          R_ ( <span class="number">0</span>,<span class="number">0</span> ), R_ ( <span class="number">0</span>,<span class="number">1</span> ), R_ ( <span class="number">0</span>,<span class="number">2</span> ),</span><br><span class="line">          R_ ( <span class="number">1</span>,<span class="number">0</span> ), R_ ( <span class="number">1</span>,<span class="number">1</span> ), R_ ( <span class="number">1</span>,<span class="number">2</span> ),</span><br><span class="line">          R_ ( <span class="number">2</span>,<span class="number">0</span> ), R_ ( <span class="number">2</span>,<span class="number">1</span> ), R_ ( <span class="number">2</span>,<span class="number">2</span> )</span><br><span class="line">        );</span><br><span class="line">    t = ( Mat_&lt;<span class="keyword">double</span>&gt; ( <span class="number">3</span>,<span class="number">1</span> ) &lt;&lt; t_ ( <span class="number">0</span>,<span class="number">0</span> ), t_ ( <span class="number">1</span>,<span class="number">0</span> ), t_ ( <span class="number">2</span>,<span class="number">0</span> ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">-- Max dist : <span class="number">95.000000</span> </span><br><span class="line">-- Min dist : <span class="number">7.000000</span> </span><br><span class="line">一共找到了<span class="number">81</span>组匹配点</span><br><span class="line"><span class="number">3</span>d<span class="number">-3</span>d pairs: <span class="number">75</span></span><br><span class="line">W=  <span class="number">11.8688</span> <span class="number">-0.717698</span>   <span class="number">1.89486</span></span><br><span class="line"> <span class="number">-1.88065</span>   <span class="number">3.83391</span>  <span class="number">-5.78219</span></span><br><span class="line">  <span class="number">3.25846</span>  <span class="number">-5.82734</span>   <span class="number">9.65267</span></span><br><span class="line">U=  <span class="number">0.592295</span>  <span class="number">-0.805658</span> <span class="number">-0.0101195</span></span><br><span class="line"> <span class="number">-0.418171</span>  <span class="number">-0.318113</span>   <span class="number">0.850845</span></span><br><span class="line">  <span class="number">0.688709</span>   <span class="number">0.499719</span>   <span class="number">0.525319</span></span><br><span class="line">V=   <span class="number">0.64736</span>  <span class="number">-0.761401</span> <span class="number">-0.0345329</span></span><br><span class="line"> <span class="number">-0.388765</span>  <span class="number">-0.368829</span>   <span class="number">0.844291</span></span><br><span class="line">  <span class="number">0.655581</span>   <span class="number">0.533135</span>   <span class="number">0.534772</span></span><br><span class="line">ICP via SVD results: </span><br><span class="line">R = [<span class="number">0.9972065647956201</span>, <span class="number">0.05834273442898391</span>, <span class="number">-0.04663895869192625</span>;</span><br><span class="line"> <span class="number">-0.05787745545449197</span>, <span class="number">0.998260122172866</span>, <span class="number">0.01126626067193237</span>;</span><br><span class="line"> <span class="number">0.04721511705620757</span>, <span class="number">-0.008535444848613793</span>, <span class="number">0.9988482762174666</span>]</span><br><span class="line">t = [<span class="number">0.1379879629890433</span>;</span><br><span class="line"> <span class="number">-0.06551699470729988</span>;</span><br><span class="line"> <span class="number">-0.02981649388290575</span>]</span><br><span class="line">R_inv = [<span class="number">0.9972065647956201</span>, <span class="number">-0.05787745545449197</span>, <span class="number">0.04721511705620757</span>;</span><br><span class="line"> <span class="number">0.05834273442898391</span>, <span class="number">0.998260122172866</span>, <span class="number">-0.008535444848613793</span>;</span><br><span class="line"> <span class="number">-0.04663895869192625</span>, <span class="number">0.01126626067193237</span>, <span class="number">0.9988482762174666</span>]</span><br><span class="line">t_inv = [<span class="number">-0.1399866702492459</span>;</span><br><span class="line"> <span class="number">0.05709791102272541</span>;</span><br><span class="line"> <span class="number">0.03695589996443214</span>]</span><br></pre></td></tr></table></figure>
<h2 id="10-2-非线性优化方法"><a href="#10-2-非线性优化方法" class="headerlink" title="10.2 非线性优化方法"></a>10.2 非线性优化方法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// g2o edge</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EdgeProjectXYZRGBDPoseOnly</span> :</span> <span class="keyword">public</span> g2o::BaseUnaryEdge&lt;<span class="number">3</span>, Eigen::Vector3d, g2o::VertexSE3Expmap&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW;</span><br><span class="line">    EdgeProjectXYZRGBDPoseOnly( <span class="keyword">const</span> Eigen::Vector3d&amp; point ) : _point(point) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">computeError</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> g2o::VertexSE3Expmap* pose = <span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> g2o::VertexSE3Expmap*&gt; ( _vertices[<span class="number">0</span>] );</span><br><span class="line">        <span class="comment">// measurement is p, point is p'</span></span><br><span class="line">        _error = _measurement - pose-&gt;estimate().<span class="built_in">map</span>( _point );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">linearizeOplus</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        g2o::VertexSE3Expmap* pose = <span class="keyword">static_cast</span>&lt;g2o::VertexSE3Expmap *&gt;(_vertices[<span class="number">0</span>]);</span><br><span class="line">        g2o::<span class="function">SE3Quat <span class="title">T</span><span class="params">(pose-&gt;estimate())</span></span>;</span><br><span class="line">        Eigen::Vector3d xyz_trans = T.<span class="built_in">map</span>(_point);</span><br><span class="line">        <span class="keyword">double</span> x = xyz_trans[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">double</span> y = xyz_trans[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">double</span> z = xyz_trans[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">0</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">1</span>) = -z;</span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">2</span>) = y;</span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">3</span>) = <span class="number">-1</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">0</span>,<span class="number">5</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">0</span>) = z;</span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">2</span>) = -x;</span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">4</span>) = <span class="number">-1</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">1</span>,<span class="number">5</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">0</span>) = -y;</span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">1</span>) = x;</span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">3</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">        _jacobianOplusXi(<span class="number">2</span>,<span class="number">5</span>) = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">read</span> <span class="params">( istream&amp; in )</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">write</span> <span class="params">( ostream&amp; out )</span> <span class="keyword">const</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    Eigen::Vector3d _point;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">calling bundle adjustment</span><br><span class="line">iteration= <span class="number">0</span>	 chi2= <span class="number">18157.747747</span>	 time= <span class="number">3.7213e-05</span>	 cumTime= <span class="number">3.7213e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">1</span>	 chi2= <span class="number">18151.933202</span>	 time= <span class="number">1.1232e-05</span>	 cumTime= <span class="number">4.8445e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">2</span>	 chi2= <span class="number">18151.932131</span>	 time= <span class="number">1.0144e-05</span>	 cumTime= <span class="number">5.8589e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">3</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">1.097e-05</span>	 cumTime= <span class="number">6.9559e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">4</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.71e-06</span>	 cumTime= <span class="number">7.9269e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">5</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.615e-06</span>	 cumTime= <span class="number">8.8884e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">6</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.521e-06</span>	 cumTime= <span class="number">9.8405e-05</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">7</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.583e-06</span>	 cumTime= <span class="number">0.000107988</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">8</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.505e-06</span>	 cumTime= <span class="number">0.000117493</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">iteration= <span class="number">9</span>	 chi2= <span class="number">18151.932130</span>	 time= <span class="number">9.484e-06</span>	 cumTime= <span class="number">0.000126977</span>	 edges= <span class="number">75</span>	 schur= <span class="number">0</span></span><br><span class="line">optimization costs time: <span class="number">0.000380717</span> seconds.</span><br><span class="line"></span><br><span class="line">after optimization:</span><br><span class="line">T=</span><br><span class="line">   <span class="number">0.997207</span>   <span class="number">0.0583427</span>   <span class="number">-0.046639</span>    <span class="number">0.137988</span></span><br><span class="line"> <span class="number">-0.0578775</span>     <span class="number">0.99826</span>   <span class="number">0.0112663</span>   <span class="number">-0.065517</span></span><br><span class="line">  <span class="number">0.0472151</span> <span class="number">-0.00853546</span>    <span class="number">0.998848</span>  <span class="number">-0.0298169</span></span><br><span class="line">          <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span>           <span class="number">1</span></span><br><span class="line">p1 = [<span class="number">-0.0374123</span>, <span class="number">-0.830816</span>, <span class="number">2.7448</span>]</span><br><span class="line">p2 = [<span class="number">-0.0111479</span>, <span class="number">-0.746763</span>, <span class="number">2.7652</span>]</span><br><span class="line">(R*p2+t) = [<span class="number">-0.04566300488482969</span>;</span><br><span class="line"> <span class="number">-0.7791822151698653</span>;</span><br><span class="line"> <span class="number">2.738046267661636</span>]</span><br><span class="line"></span><br><span class="line">p1 = [<span class="number">-0.243698</span>, <span class="number">-0.117719</span>, <span class="number">1.5848</span>]</span><br><span class="line">p2 = [<span class="number">-0.299118</span>, <span class="number">-0.0975683</span>, <span class="number">1.6558</span>]</span><br><span class="line">(R*p2+t) = [<span class="number">-0.243212054430598</span>;</span><br><span class="line"> <span class="number">-0.1269486029625337</span>;</span><br><span class="line"> <span class="number">1.610786345002579</span>]</span><br><span class="line"></span><br><span class="line">p1 = [<span class="number">-0.627753</span>, <span class="number">0.160186</span>, <span class="number">1.3396</span>]</span><br><span class="line">p2 = [<span class="number">-0.709645</span>, <span class="number">0.159033</span>, <span class="number">1.4212</span>]</span><br><span class="line">(R*p2+t) = [<span class="number">-0.6266796777024644</span>;</span><br><span class="line"> <span class="number">0.1503229238263245</span>;</span><br><span class="line"> <span class="number">1.354883323538178</span>]</span><br><span class="line"></span><br><span class="line">p1 = [<span class="number">-0.323443</span>, <span class="number">0.104873</span>, <span class="number">1.4266</span>]</span><br><span class="line">p2 = [<span class="number">-0.399079</span>, <span class="number">0.12047</span>, <span class="number">1.4838</span>]</span><br><span class="line">(R*p2+t) = [<span class="number">-0.3221508525590339</span>;</span><br><span class="line"> <span class="number">0.09455772952719482</span>;</span><br><span class="line"> <span class="number">1.432403794814274</span>]</span><br><span class="line"></span><br><span class="line">p1 = [<span class="number">-0.627221</span>, <span class="number">0.101454</span>, <span class="number">1.3116</span>]</span><br><span class="line">p2 = [<span class="number">-0.709709</span>, <span class="number">0.100216</span>, <span class="number">1.3998</span>]</span><br><span class="line">(R*p2+t) = [<span class="number">-0.6291763602679332</span>;</span><br><span class="line"> <span class="number">0.09137127679150184</span>;</span><br><span class="line"> <span class="number">1.334006907588644</span>]</span><br></pre></td></tr></table></figure>
<p>待写！！！</p>

    </div>
    
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>xiaohu
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiao-hu.com.cn/2019/05/21/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/" title="视觉slam十四讲   7.视觉里程计1">https://xiao-hu.com.cn/2019/05/21/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/05/19/ubuntu16-%E5%B0%8F%E8%A7%85%E5%8F%8C%E7%9B%AE%E6%91%84%E5%83%8F%E5%A4%B4-MYNT-EYE-S-SDK%E5%AE%89%E8%A3%85/" rel="next" title="ubuntu16 小觅双目摄像头 MYNT-EYE-S-SDK安装">
                  <i class="fa fa-chevron-left"></i> ubuntu16 小觅双目摄像头 MYNT-EYE-S-SDK安装
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2019/05/25/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" rel="prev" title="视觉slam十四讲 8.视觉里程计2">
                  视觉slam十四讲 8.视觉里程计2 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  
  

  





  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-特征点法"><span class="nav-number">1.</span> <span class="nav-text">1 特征点法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-特征点"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 特征点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-ORB特征"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 ORB特征</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-特征匹配"><span class="nav-number">1.3.</span> <span class="nav-text">1.3  特征匹配</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-特征提取与匹配"><span class="nav-number">2.</span> <span class="nav-text">2 特征提取与匹配</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-2D-2D：对极几何"><span class="nav-number">3.</span> <span class="nav-text">3  2D-2D：对极几何</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-对极约束"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 对极约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-本质矩阵"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 本质矩阵</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-单应矩阵"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 单应矩阵</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#讨论"><span class="nav-number">3.4.</span> <span class="nav-text">讨论</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-实践：对极约束求相机运动"><span class="nav-number">4.</span> <span class="nav-text">4 实践：对极约束求相机运动</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-三角测量"><span class="nav-number">5.</span> <span class="nav-text">5 三角测量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-实践：三角测量"><span class="nav-number">6.</span> <span class="nav-text">6 实践：三角测量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-3D-2D-PnP"><span class="nav-number">7.</span> <span class="nav-text">7 3D-2D:PnP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-直接线性变换"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 直接线性变换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-P3P"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 P3P</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-Bundle-Adjustment"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 Bundle Adjustment</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-实践：求解PnP"><span class="nav-number">8.</span> <span class="nav-text">8 实践：求解PnP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-使用EPnP求解位姿"><span class="nav-number">8.1.</span> <span class="nav-text">8.1 使用EPnP求解位姿</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-使用BA优化"><span class="nav-number">8.2.</span> <span class="nav-text">8.2 使用BA优化</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-3D-3D-ICP"><span class="nav-number">9.</span> <span class="nav-text">9 3D-3D:ICP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-SVD方法"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 SVD方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-非线性优化方法"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 非线性优化方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-实践：求解ICP"><span class="nav-number">10.</span> <span class="nav-text">10 实践：求解ICP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-SVD方法"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 SVD方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-非线性优化方法"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 非线性优化方法</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="xiaohu"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">xiaohu</p>
  <div class="site-description" itemprop="description">博观而约取,厚积而薄发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Xiao-Hu-Z" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;Xiao-Hu-Z" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:znxxhn@gmail.com" title="E-Mail &amp;rarr; mailto:znxxhn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaohu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">554k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:23</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script><script src="/js/bookmark.js?v=7.4.2"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>






  <script src="/js/local-search.js?v=7.4.2"></script>













  

  
      
<script type="text/x-mathjax-config">
    MathJax.Ajax.config.path['mhchem'] = '//cdn.jsdelivr.net/npm/mathjax-mhchem@3';

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        extensions: ['[mhchem]/mhchem.js'],
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

  

  
  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  
  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

