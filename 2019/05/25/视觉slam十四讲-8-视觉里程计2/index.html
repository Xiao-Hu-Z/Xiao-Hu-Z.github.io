<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">
  <link rel="alternate" href="/atom.xml" title="xiaohu博客" type="application/atom+xml">


  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "b7ba025a"
    });
  daovoice('update');
  </script>


<link rel="stylesheet" href="/css/main.css?v=7.4.2">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: true,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="1 直接法的引出 特征点法的缺点：  关键点的提取和描述子计算非常耗时 使用特征点忽略了除特征点以外的其他信息 相机可能运动到特征点缺失的地方，这些地方没有明显的纹理信息   克服这些缺点的思路  保留特征点，但是只计算关键点，不计算描述子，使用光流法（Optical Flow）来跟踪特征点的运动 只计算关键点，不计算描述子，使用直接法（Direct Method）计算特征点在下一个时刻出现的位置">
<meta property="og:type" content="article">
<meta property="og:title" content="视觉slam十四讲 8.视觉里程计2">
<meta property="og:url" content="https:&#x2F;&#x2F;xiao-hu.com.cn&#x2F;2019&#x2F;05&#x2F;25&#x2F;%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12&#x2F;index.html">
<meta property="og:site_name" content="xiaohu博客">
<meta property="og:description" content="1 直接法的引出 特征点法的缺点：  关键点的提取和描述子计算非常耗时 使用特征点忽略了除特征点以外的其他信息 相机可能运动到特征点缺失的地方，这些地方没有明显的纹理信息   克服这些缺点的思路  保留特征点，但是只计算关键点，不计算描述子，使用光流法（Optical Flow）来跟踪特征点的运动 只计算关键点，不计算描述子，使用直接法（Direct Method）计算特征点在下一个时刻出现的位置">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190625221823922.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626225849655.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626220949888.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626222221875.png">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626222350574.png">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626222447792.png">
<meta property="og:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190626222510413.png">
<meta property="og:updated_time" content="2019-11-19T08:15:17.944Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;img-blog.csdnimg.cn&#x2F;20190625221823922.png?x-oss-process=image&#x2F;watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="https://xiao-hu.com.cn/2019/05/25/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>视觉slam十四讲 8.视觉里程计2 | xiaohu博客</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">xiaohu博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xiao-hu.com.cn/2019/05/25/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="xiaohu">
      <meta itemprop="description" content="博观而约取,厚积而薄发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="xiaohu博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          视觉slam十四讲 8.视觉里程计2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-05-25 16:14:38" itemprop="dateCreated datePublished" datetime="2019-05-25T16:14:38+08:00">2019-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-19 16:15:17" itemprop="dateModified" datetime="2019-11-19T16:15:17+08:00">2019-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/VSLAM/" itemprop="url" rel="index">
                    <span itemprop="name">VSLAM</span>
                  </a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>16 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-直接法的引出"><a href="#1-直接法的引出" class="headerlink" title="1 直接法的引出"></a>1 直接法的引出</h1><ol>
<li><p>特征点法的缺点：</p>
<ul>
<li>关键点的提取和描述子计算非常耗时</li>
<li>使用特征点忽略了除特征点以外的其他信息</li>
<li>相机可能运动到特征点缺失的地方，这些地方没有明显的纹理信息</li>
</ul>
</li>
<li><p>克服这些缺点的思路</p>
<ul>
<li>保留特征点，但是只计算关键点，不计算描述子，使用光流法（Optical Flow）来跟踪特征点的运动</li>
<li>只计算关键点，不计算描述子，使用直接法（Direct Method）计算特征点在下一个时刻出现的位置。</li>
<li>不计算关键字，也不计算描述子，根据像素灰度差异，直接计算相机运动</li>
</ul>
<p>第一种方法仍然使用特征点，只是把匹配描述子替换成光流跟踪，估计相机运动仍然使用对极几何、PnP或者ICP算法<br>提取特征点，而在后两种中，会根据图像的<strong>像素灰度信息</strong>来计算相机运动，特闷都称为<strong>直接法</strong></p>
<ol>
<li>特征点法和直接法区别：</li>
</ol>
<ul>
<li>特征点法：<strong>最小化重投影误差</strong>（Reprojection Error）优化相机运动，需要精确地知道空间点在两个相机中投影后的像素位置，这也是需要匹配跟踪的原因，但是计算量大。</li>
<li>直接法：不需要知道点和点的匹配关系，通过<strong>最小化光度误差</strong>（Photometric Error）</li>
</ul>
<ol>
<li>直接法根据 像素的亮度信息，估计相机的运动，可以完全不用计算关键点和描述子，于是，既避免了 特征的计算时间，也避免了特征缺失的情况。只要场景中存在明暗变化（可以是渐变，不形成局部的图像梯度），直接法就能工作。</li>
<li>根据使用像素的数量，直接法分为稀疏、稠密和 半稠密三种。相比于特征点法只能重构稀疏特征点（稀疏地图），直接法还具有恢复稠密或 半稠密结构的能力。</li>
</ol>
<h1 id="2-光流（Optical-Flow"><a href="#2-光流（Optical-Flow" class="headerlink" title="2 光流（Optical Flow)"></a>2 光流（Optical Flow)</h1></li>
<li><p>直接法是从光流演变而来的，光流描述了像素 在图像中的运动，而直接法则附带着一个相机运动模型。</p>
<p>（1）计算部分像素运动的稀疏光流<br>（2）计算所有像素运动的稠密光流</p>
</li>
</ol><a id="more"></a>
<p><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190625221823922.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"></p>
<p> <strong>Lucas-Kanade光流</strong></p>
<ol>
<li><p>引入 光流法的基本假设：</p>
<p> <strong>灰度不变假设</strong>：同一个空间点的像素灰度值，在各个图像中是固定不变的。</p>
<script type="math/tex; mode=display">I(x+dx,y+dy,t+dt)=I(x,y,t)</script><p> 对左边进行泰勒一阶展开,保留一阶项</p>
<script type="math/tex; mode=display">I(x+dx,y+dy,t+dt)\approx I(x,y,t)+\frac{\partial I}{\partial x}dx+\frac{\partial I}{\partial y}dy+\frac{\partial I}{\partial t}dt</script><script type="math/tex; mode=display">\frac{\partial I}{\partial x}dx+\frac{\partial I}{\partial y}dy+\frac{\partial I}{\partial t}dt=0</script><p> 两边同时除以dt,得：</p>
<script type="math/tex; mode=display">\frac{\partial I}{\partial x}\frac{dx}{dt}+\frac{\partial I}{\partial y}\frac{dy}{dt}=-\frac{\partial I}{\partial t}</script><p> dx/dt 为像素在 x 轴上运动速度，而 dy/dt 为 y 轴速度，把它们记为 u, v。同 时$∂I/∂x$为图像在该点处 x 方向的梯度，另一项则是在 y 方向的梯度，记为 $I_{x}, I_{y}$。图像灰度对时间的变化量记为 $I_{t}$,写成矩阵形式：</p>
<script type="math/tex; mode=display">\begin{bmatrix}
I_{x} & 
I_{y}\end{bmatrix}\begin{bmatrix}
u\\ 
v\end{bmatrix}=-I_{t}</script><p> <strong>运动相同假设</strong>：设某一个窗 口内的像素具有相同的运动。</p>
<p> 考虑一个大小ω∗ω窗口，含有$ω^{2}$个像素，得到$ω^{2}$个方程:</p>
<script type="math/tex; mode=display">\begin{bmatrix}
I_{x} & 
I_{y}\end{bmatrix}_{k}\begin{bmatrix}
u\\ 
v\end{bmatrix}=-I_{tk},\quad k=1,2...,ω^{2}.</script></li>
</ol>
<p>记：</p>
<script type="math/tex; mode=display">
A=\begin{bmatrix}
\begin{bmatrix}
I_{x} & 
I_{y}\end{bmatrix}_{1}\\ 
\vdots \\ 
\begin{bmatrix}
I_{x} & 
I_{y}\end{bmatrix}_{k}\end{bmatrix},b=\begin{bmatrix}
I_{t1}\\ 
\vdots \\ 
I_{tk}\end{bmatrix}</script><p>整个方程为：</p>
<script type="math/tex; mode=display">A\begin{bmatrix}
u\\ 
v\end{bmatrix}=-b</script><p>这是一个关于 u, v 的超定线性方程，传统解法是求最小二乘解</p>
<script type="math/tex; mode=display">\begin{bmatrix}
u\\ 
v\end{bmatrix}^{*}=-(A^TA)^{-1}A^{T}b</script><p>可以得到像素在图像间的运动$u,v$,由于像素梯度仅在局部有效，如果一次迭代不够好，会多次迭代。在SLAM中，LK光流长被用来估计角点的运动。</p>
<h1 id="3-实践：LK光流"><a href="#3-实践：LK光流" class="headerlink" title="3 实践：LK光流"></a>3 实践：LK光流</h1><h2 id="3-1-使用TMU公开数据集"><a href="#3-1-使用TMU公开数据集" class="headerlink" title="3.1 使用TMU公开数据集"></a>3.1 使用TMU公开数据集</h2><h2 id="3-2-使用LK光流"><a href="#3-2-使用LK光流" class="headerlink" title="3.2 使用LK光流"></a>3.2 使用LK光流</h2><ul>
<li>角点处稳定，边缘处会滑动，<strong>沿边缘移动时特征快的内容基本不变</strong>。<ul>
<li>匹配描述子的方法在相机运动较大时仍能成功， 而光流必须要求相机运动是微小的。从这方面来说，光流的鲁棒性比描述子差一些。。</li>
<li>LK光流跟踪能够直接得到特征点的对应关系，大多数只会碰到特征点跟丢，不太会遇到误匹配。</li>
</ul>
</li>
<li>可以通过光流跟踪的特征点，用PnP、ICP或对极几何来估计相机运动。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/video/tracking.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    if ( argc != 2 )</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        cout&lt;&lt;"usage: useLK path_to_dataset"&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">//        return 1;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//    string path_to_dataset = argv[1];</span></span><br><span class="line"><span class="comment">//    string associate_file = path_to_dataset + "/associate.txt";</span></span><br><span class="line">    <span class="built_in">string</span> path_to_dataset =<span class="string">"/home/xiaohu//slambook-master/ch8/rgbd_dataset_freiburg1_desk"</span>;</span><br><span class="line">    <span class="built_in">string</span> associate_file = path_to_dataset+<span class="string">"/associate.txt"</span>;</span><br><span class="line">    <span class="function">ifstream <span class="title">fin</span><span class="params">( associate_file )</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ( !fin ) </span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">cerr</span>&lt;&lt;<span class="string">"I cann't find associate.txt!"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">string</span> rgb_file, depth_file, time_rgb, time_depth;</span><br><span class="line">    <span class="built_in">list</span>&lt; cv::Point2f &gt; keypoints;      <span class="comment">// 因为要删除跟踪失败的点，使用list</span></span><br><span class="line">    cv::Mat color, depth, last_color;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> index=<span class="number">0</span>; index&lt;<span class="number">100</span>; index++ )</span><br><span class="line">    &#123;</span><br><span class="line">        fin&gt;&gt;time_rgb&gt;&gt;rgb_file&gt;&gt;time_depth&gt;&gt;depth_file;</span><br><span class="line">        color = cv::imread( path_to_dataset+<span class="string">"/"</span>+rgb_file );</span><br><span class="line">        depth = cv::imread( path_to_dataset+<span class="string">"/"</span>+depth_file, <span class="number">-1</span> );</span><br><span class="line">        <span class="keyword">if</span> (index ==<span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 对第一帧提取FAST特征点</span></span><br><span class="line">            <span class="built_in">vector</span>&lt;cv::KeyPoint&gt; kps;</span><br><span class="line">            cv::Ptr&lt;cv::FastFeatureDetector&gt; detector = cv::FastFeatureDetector::create();</span><br><span class="line">            detector-&gt;detect( color, kps );</span><br><span class="line">            <span class="keyword">for</span> ( <span class="keyword">auto</span> kp:kps )</span><br><span class="line">                keypoints.push_back( kp.pt );</span><br><span class="line">            last_color = color;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( color.data==<span class="literal">nullptr</span> || depth.data==<span class="literal">nullptr</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">// 对其他帧用LK跟踪特征点</span></span><br><span class="line">        <span class="built_in">vector</span>&lt;cv::Point2f&gt; next_keypoints; </span><br><span class="line">        <span class="built_in">vector</span>&lt;cv::Point2f&gt; prev_keypoints;</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">auto</span> kp:keypoints )</span><br><span class="line">            prev_keypoints.push_back(kp);</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; status;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; error; </span><br><span class="line">        chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">        cv::calcOpticalFlowPyrLK( last_color, color, prev_keypoints, next_keypoints, status, error );</span><br><span class="line">        chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">        chrono::duration&lt;<span class="keyword">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="keyword">double</span>&gt;&gt;( t2-t1 );</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"LK Flow use time："</span>&lt;&lt;time_used.count()&lt;&lt;<span class="string">" seconds."</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="comment">// 把跟丢的点删掉</span></span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">0</span>; </span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">auto</span> iter=keypoints.begin(); iter!=keypoints.end(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ( status[i] == <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                iter = keypoints.erase(iter);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *iter = next_keypoints[i];</span><br><span class="line">            iter++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"tracked keypoints: "</span>&lt;&lt;keypoints.size()&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">if</span> (keypoints.size() == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">"all keypoints are lost."</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 画出 keypoints</span></span><br><span class="line">        cv::Mat img_show = color.clone();</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">auto</span> kp:keypoints )</span><br><span class="line">            cv::circle(img_show, kp, <span class="number">10</span>, cv::Scalar(<span class="number">0</span>, <span class="number">240</span>, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">        cv::imshow(<span class="string">"corners"</span>, img_show);</span><br><span class="line">        cv::waitKey(<span class="number">0</span>);</span><br><span class="line">        last_color = color;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-直接法"><a href="#4-直接法" class="headerlink" title="4 直接法"></a>4 直接法</h1><h2 id="4-1-直接法的推导"><a href="#4-1-直接法的推导" class="headerlink" title="4.1 直接法的推导"></a>4.1 直接法的推导</h2><p> 记P的世界坐标为$[X,Y,Z]$,它在两个相机上成像，记非齐次像素坐标为$p_{1}$,$p_{12}$。<br> 目标是求第一个相机到第二个相 机的相对位姿变换。我们以第一个相机为参照系，设第二个相机旋转和平移为 R, t（对应李代数为 ξ）。<br> <img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626225849655.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"></p>
<script type="math/tex; mode=display">p_{1}=\begin{bmatrix}
u\\ 
v\\ 
1\end{bmatrix}_{1}=\frac{1}{Z_{1}}KP</script><script type="math/tex; mode=display">p_{1}=\begin{bmatrix}
u\\ 
v\\ 
1\end{bmatrix}_{2}=\frac{1}{Z_{1}}K(RP+t)=\frac{1}{Z_{2}}K(exp(\xi ^\wedge )P)_{1:3}</script><p>特征点法中，通过匹配描述子，知道了 p1, p2 的像素位置，可以计 算重投影的位置。<br>直接法中，由于没有特征匹配，无从知道哪一个 p2 与 p1 对应着同一个点<br>直接法的思路是根据当前相机的位姿估计值，来寻找 p2 的位置。但若相机位姿不够好，p2 的外观和 p1 会有明显差别。于是，为了减小这个差别，我们优化相机的位姿，来寻找与 p1 更相似的 p2。这同样可以通过解一个优化问题，但此时最小化的不是重投影误差，而是<strong>光度误差</strong>，也就是 P 的两个像的亮度误差:</p>
<script type="math/tex; mode=display">e=I_{1}\left ( p_{1} \right )-I_{2}\left ( p_{2} \right )</script><p>优化目标为该误差的二范数：</p>
<script type="math/tex; mode=display">\min_{ϵ}J(\xi )=\left \| e \right \|^{2}</script><p>仍是<strong>基于灰度不变假设</strong>，许多个（比如 N 个）空间点 $P_{i}$，那么，整 个相机位姿估计问题变为：</p>
<script type="math/tex; mode=display">\min_{ϵ}J(\xi )=\sum_{i=1}^{N}e^{T}_{i}e_{i},\quad e_{i}=I_{1}(p_{1,i})-I_{2}(p_{2,i})</script><p>优化变量：相机位姿$\xi$,误差 e 是如何随着相机位姿 ξ 变化的，需要分析它们的导数关系,因此，使用李代数上的扰动模型。我 们给 $exp(ξ)$ 左乘一个小扰动 $exp(δξ)$，得：<br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626220949888.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjkwNTE0MQ==,size_16,color_FFFFFF,t_70"><br>q 为 P 在扰动之后，位于第二个相机坐标系下的坐标，而 u 为它的像素坐标。利用一阶泰勒展开，有：<br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626222221875.png"></p>
<ol>
<li>∂I2/∂u 为 u 处的像素梯度；</li>
<li>∂u/∂q 为投影方程关于相机坐标系下的三维点的导数。记$q=[X,Y,Z]$<br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626222350574.png"></li>
<li><p>∂q/∂δξ 为变换后的三维点对变换的导数<br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626222447792.png">后两项合并:<br><img alt="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20190626222510413.png"><br>对于 N 个点的问题，我们可以用这种方法计算优化问题的雅可比矩阵，然后使用 高斯牛顿法或列文伯格——马夸尔特方法计算增量，迭代求解。</p>
<h2 id="4-2-直接法的讨论"><a href="#4-2-直接法的讨论" class="headerlink" title="4.2 直接法的讨论"></a>4.2 直接法的讨论</h2><p>在上面的推导中，P是一个已知位置的空间点，在RGB-D相机下，我们可以把任意像素反投影到三维空间，然后投影到下一个图像中。如果在单目相机中，可以使用已经估计好位置的特征点（虽然是特征点，但直接法里是可以避免计算描述子的）。根据P的来源，把直接法进行分类：</p>
<ul>
<li>P来自于<strong>稀疏特征点</strong>，称之为<strong>稀疏直接法</strong>。通常我们使用数百个特征点，并且会像L-K光流那样，假设它周围像素也是不变的。这种稀疏直接法速度不必计算描述子，并且只使用数百个像素，因此速度最快，但只能计算稀疏的重构。</li>
<li>P来自<strong>部分像素</strong>, 这称之为<strong>半稠密（Semi-Dense）的直接法</strong>，考虑只使用带有梯度的像素点，舍弃像素梯度不明显的地方，可以重构一个半稠密结构。</li>
<li>P为<strong>所有像素</strong>，称为<strong>稠密直接法</strong>。稠密重构需要计算所有像素（一般几十万至几百万个），因此多数不能在现有的 CPU上实时计算，需要GPU的加速。</li>
</ul>
</li>
</ol>
<p>可以看到，从稀疏到稠密重构，都可以用直接法来计算。它们的计算量是逐渐增长的。<strong>稀疏方法可以快速地求解相机位姿，而稠密方法可以建立完整地图</strong>。</p>
<h1 id="5-实践：RGB-D的直接法"><a href="#5-实践：RGB-D的直接法" class="headerlink" title="5 实践：RGB-D的直接法"></a>5 实践：RGB-D的直接法</h1><p> 图优化：误差项为单个像素的光度误差。由于 g2o 中本身没有计算光度误差的边，我们需要 自己定义一种新的边。在上述的建模中，直接法图优化问题是由一个相机位姿顶点与许多条一元边组成的。</p>
<h2 id="5-1-稀梳直接法"><a href="#5-1-稀梳直接法" class="headerlink" title="5.1 稀梳直接法"></a>5.1 稀梳直接法</h2> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;climits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/core/core.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/base_unary_edge.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/block_solver.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/core/robust_kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;g2o/types/sba/types_six_dof_expmap.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> g2o;</span><br><span class="line"></span><br><span class="line"><span class="comment">/********************************************</span></span><br><span class="line"><span class="comment"> * 本节演示了RGBD上的稀疏直接法 </span></span><br><span class="line"><span class="comment"> ********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次测量的值，包括一个世界坐标系下三维点与一个灰度值</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Measurement</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Measurement ( Eigen::Vector3d p, <span class="keyword">float</span> g ) : pos_world ( p ), grayscale ( g ) &#123;&#125;</span><br><span class="line">    Eigen::Vector3d pos_world;</span><br><span class="line">    <span class="keyword">float</span> grayscale;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> Eigen::<span class="function">Vector3d <span class="title">project2Dto3D</span> <span class="params">( <span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> d, <span class="keyword">float</span> fx, <span class="keyword">float</span> fy, <span class="keyword">float</span> cx, <span class="keyword">float</span> cy, <span class="keyword">float</span> scale )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> zz = <span class="keyword">float</span> ( d ) /scale;</span><br><span class="line">    <span class="keyword">float</span> xx = zz* ( x-cx ) /fx;</span><br><span class="line">    <span class="keyword">float</span> yy = zz* ( y-cy ) /fy;</span><br><span class="line">    <span class="keyword">return</span> Eigen::Vector3d ( xx, yy, zz );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> Eigen::<span class="function">Vector2d <span class="title">project3Dto2D</span> <span class="params">( <span class="keyword">float</span> x, <span class="keyword">float</span> y, <span class="keyword">float</span> z, <span class="keyword">float</span> fx, <span class="keyword">float</span> fy, <span class="keyword">float</span> cx, <span class="keyword">float</span> cy )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> u = fx*x/z+cx;</span><br><span class="line">    <span class="keyword">float</span> v = fy*y/z+cy;</span><br><span class="line">    <span class="keyword">return</span> Eigen::Vector2d ( u,v );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接法估计位姿</span></span><br><span class="line"><span class="comment">// 输入：测量值（空间点的灰度），新的灰度图，相机内参； 输出：相机位姿</span></span><br><span class="line"><span class="comment">// 返回：true为成功，false失败</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">poseEstimationDirect</span> <span class="params">( <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Measurement&gt;&amp; measurements, cv::Mat* gray, Eigen::Matrix3f&amp; intrinsics, Eigen::Isometry3d&amp; Tcw )</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// project a 3d point into an image plane, the error is photometric error</span></span><br><span class="line"><span class="comment">// an unary edge with one vertex SE3Expmap (the pose of camera)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EdgeSE3ProjectDirect</span>:</span> <span class="keyword">public</span> BaseUnaryEdge&lt; <span class="number">1</span>, <span class="keyword">double</span>, VertexSE3Expmap&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><br><span class="line"></span><br><span class="line">    EdgeSE3ProjectDirect() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    EdgeSE3ProjectDirect ( Eigen::Vector3d point, <span class="keyword">float</span> fx, <span class="keyword">float</span> fy, <span class="keyword">float</span> cx, <span class="keyword">float</span> cy, cv::Mat* image )</span><br><span class="line">        : x_world_ ( point ), fx_ ( fx ), fy_ ( fy ), cx_ ( cx ), cy_ ( cy ), image_ ( image )</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">computeError</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> VertexSE3Expmap* v  =<span class="keyword">static_cast</span>&lt;<span class="keyword">const</span> VertexSE3Expmap*&gt; ( _vertices[<span class="number">0</span>] );</span><br><span class="line">        <span class="comment">//.map函数，它的功能是把世界坐标系下三维点变换到相机坐标系，函数在g2o/types/sim3/sim3.h</span></span><br><span class="line">        Eigen::Vector3d x_local = v-&gt;estimate().<span class="built_in">map</span> ( x_world_ );</span><br><span class="line">        <span class="keyword">float</span> x = x_local[<span class="number">0</span>]*fx_/x_local[<span class="number">2</span>] + cx_;</span><br><span class="line">        <span class="keyword">float</span> y = x_local[<span class="number">1</span>]*fy_/x_local[<span class="number">2</span>] + cy_;</span><br><span class="line">        <span class="comment">// check x,y is in the image</span></span><br><span class="line">        <span class="keyword">if</span> ( x<span class="number">-4</span>&lt;<span class="number">0</span> || ( x+<span class="number">4</span> ) &gt;image_-&gt;cols || ( y<span class="number">-4</span> ) &lt;<span class="number">0</span> || ( y+<span class="number">4</span> ) &gt;image_-&gt;rows )</span><br><span class="line">        &#123;</span><br><span class="line">            _error ( <span class="number">0</span>,<span class="number">0</span> ) = <span class="number">0.0</span>;</span><br><span class="line">            <span class="keyword">this</span>-&gt;setLevel ( <span class="number">1</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            _error ( <span class="number">0</span>,<span class="number">0</span> ) = getPixelValue ( x,y ) - _measurement;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// plus in manifold</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">linearizeOplus</span><span class="params">( )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( level() == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            _jacobianOplusXi = Eigen::Matrix&lt;<span class="keyword">double</span>, <span class="number">1</span>, <span class="number">6</span>&gt;::Zero();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        VertexSE3Expmap* vtx = <span class="keyword">static_cast</span>&lt;VertexSE3Expmap*&gt; ( _vertices[<span class="number">0</span>] );</span><br><span class="line">        Eigen::Vector3d xyz_trans = vtx-&gt;estimate().<span class="built_in">map</span> ( x_world_ );   <span class="comment">// q in book</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> x = xyz_trans[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">double</span> y = xyz_trans[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">double</span> invz = <span class="number">1.0</span>/xyz_trans[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">double</span> invz_2 = invz*invz;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">float</span> u = x*fx_*invz + cx_;</span><br><span class="line">        <span class="keyword">float</span> v = y*fy_*invz + cy_;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jacobian from se3 to u,v</span></span><br><span class="line">        <span class="comment">// NOTE that in g2o the Lie algebra is (\omega, \epsilon), where \omega is so(3) and \epsilon the translation</span></span><br><span class="line">        Eigen::Matrix&lt;<span class="keyword">double</span>, <span class="number">2</span>, <span class="number">6</span>&gt; jacobian_uv_ksai;</span><br><span class="line">        <span class="comment">//旋转在前，平移在后</span></span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">0</span> ) = - x*y*invz_2 *fx_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">1</span> ) = ( <span class="number">1</span>+ ( x*x*invz_2 ) ) *fx_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">2</span> ) = - y*invz *fx_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">3</span> ) = invz *fx_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">4</span> ) = <span class="number">0</span>;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">0</span>,<span class="number">5</span> ) = -x*invz_2 *fx_;</span><br><span class="line"></span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">0</span> ) = - ( <span class="number">1</span>+y*y*invz_2 ) *fy_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">1</span> ) = x*y*invz_2 *fy_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">2</span> ) = x*invz *fy_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">3</span> ) = <span class="number">0</span>;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">4</span> ) = invz *fy_;</span><br><span class="line">        jacobian_uv_ksai ( <span class="number">1</span>,<span class="number">5</span> ) = -y*invz_2 *fy_;</span><br><span class="line"></span><br><span class="line">        Eigen::Matrix&lt;<span class="keyword">double</span>, <span class="number">1</span>, <span class="number">2</span>&gt; jacobian_pixel_uv;</span><br><span class="line"></span><br><span class="line">        jacobian_pixel_uv ( <span class="number">0</span>,<span class="number">0</span> ) = ( getPixelValue ( u+<span class="number">1</span>,v )-getPixelValue ( u<span class="number">-1</span>,v ) ) /<span class="number">2</span>;</span><br><span class="line">        jacobian_pixel_uv ( <span class="number">0</span>,<span class="number">1</span> ) = ( getPixelValue ( u,v+<span class="number">1</span> )-getPixelValue ( u,v<span class="number">-1</span> ) ) /<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        _jacobianOplusXi = jacobian_pixel_uv*jacobian_uv_ksai;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dummy read and write functions because we don't care...</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">read</span> <span class="params">( <span class="built_in">std</span>::istream&amp; in )</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">write</span> <span class="params">( <span class="built_in">std</span>::ostream&amp; out )</span> <span class="keyword">const</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// get a gray scale value from reference image (bilinear interpolated)</span></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">float</span> <span class="title">getPixelValue</span> <span class="params">( <span class="keyword">float</span> x, <span class="keyword">float</span> y )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//双线性插值通过寻找距离这个对应坐标最近的四个像素点，来计算该点的值（灰度值或者RGB值）。</span></span><br><span class="line">        uchar* data = &amp; image_-&gt;data[ <span class="keyword">int</span> ( y ) * image_-&gt;step + <span class="keyword">int</span> ( x ) ];</span><br><span class="line">        <span class="keyword">float</span> xx = x - <span class="built_in">floor</span> ( x );</span><br><span class="line">        <span class="keyword">float</span> yy = y - <span class="built_in">floor</span> ( y );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">float</span> (</span><br><span class="line">                   ( <span class="number">1</span>-xx ) * ( <span class="number">1</span>-yy ) * data[<span class="number">0</span>] +</span><br><span class="line">                   xx* ( <span class="number">1</span>-yy ) * data[<span class="number">1</span>] +</span><br><span class="line">                   ( <span class="number">1</span>-xx ) *yy*data[ image_-&gt;step ] +</span><br><span class="line">                   xx*yy*data[image_-&gt;step+<span class="number">1</span>]</span><br><span class="line">               );</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Eigen::Vector3d x_world_;   <span class="comment">// 3D point in world frame</span></span><br><span class="line">    <span class="keyword">float</span> cx_=<span class="number">0</span>, cy_=<span class="number">0</span>, fx_=<span class="number">0</span>, fy_=<span class="number">0</span>; <span class="comment">// Camera intrinsics</span></span><br><span class="line">    cv::Mat* image_=<span class="literal">nullptr</span>;    <span class="comment">// reference image</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//    if ( argc != 2 )</span></span><br><span class="line"><span class="comment">//    &#123;</span></span><br><span class="line"><span class="comment">//        cout&lt;&lt;"usage: useLK path_to_dataset"&lt;&lt;endl;</span></span><br><span class="line"><span class="comment">//        return 1;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    srand ( ( <span class="keyword">unsigned</span> <span class="keyword">int</span> ) time ( <span class="number">0</span> ) );</span><br><span class="line"><span class="comment">//    string path_to_dataset = argv[1];</span></span><br><span class="line">    <span class="built_in">string</span> path_to_dataset =<span class="string">"/home/xiaohu//slambook-master/ch8/rgbd_dataset_freiburg1_desk"</span>;</span><br><span class="line">    <span class="built_in">string</span> associate_file = path_to_dataset + <span class="string">"/associate.txt"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ifstream <span class="title">fin</span> <span class="params">( associate_file )</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> rgb_file, depth_file, time_rgb, time_depth;</span><br><span class="line">    cv::Mat color, depth, gray;</span><br><span class="line">    <span class="built_in">vector</span>&lt;Measurement&gt; measurements;</span><br><span class="line">    <span class="comment">// 相机内参</span></span><br><span class="line">    <span class="keyword">float</span> cx = <span class="number">325.5</span>;</span><br><span class="line">    <span class="keyword">float</span> cy = <span class="number">253.5</span>;</span><br><span class="line">    <span class="keyword">float</span> fx = <span class="number">518.0</span>;</span><br><span class="line">    <span class="keyword">float</span> fy = <span class="number">519.0</span>;</span><br><span class="line">    <span class="keyword">float</span> depth_scale = <span class="number">1000.0</span>;</span><br><span class="line">    Eigen::Matrix3f K;</span><br><span class="line">    K&lt;&lt;fx,<span class="number">0.f</span>,cx,<span class="number">0.f</span>,fy,cy,<span class="number">0.f</span>,<span class="number">0.f</span>,<span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">    Eigen::Isometry3d Tcw = Eigen::Isometry3d::Identity();</span><br><span class="line"></span><br><span class="line">    cv::Mat prev_color;</span><br><span class="line">    <span class="comment">// 我们以第一个图像为参考，对后续图像和参考图像做直接法</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> index=<span class="number">0</span>; index&lt;<span class="number">10</span>; index++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"*********** loop "</span>&lt;&lt;index&lt;&lt;<span class="string">" ************"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        fin&gt;&gt;time_rgb&gt;&gt;rgb_file&gt;&gt;time_depth&gt;&gt;depth_file;</span><br><span class="line">        color = cv::imread ( path_to_dataset+<span class="string">"/"</span>+rgb_file );</span><br><span class="line">        depth = cv::imread ( path_to_dataset+<span class="string">"/"</span>+depth_file, <span class="number">-1</span> );</span><br><span class="line">        <span class="keyword">if</span> ( color.data==<span class="literal">nullptr</span> || depth.data==<span class="literal">nullptr</span> )</span><br><span class="line">            <span class="keyword">continue</span>; </span><br><span class="line">        cv::cvtColor ( color, gray, cv::COLOR_BGR2GRAY );</span><br><span class="line">        <span class="keyword">if</span> ( index ==<span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 对第一帧提取FAST特征点</span></span><br><span class="line">            <span class="built_in">vector</span>&lt;cv::KeyPoint&gt; keypoints;</span><br><span class="line">            cv::Ptr&lt;cv::FastFeatureDetector&gt; detector = cv::FastFeatureDetector::create();</span><br><span class="line">            detector-&gt;detect ( color, keypoints );</span><br><span class="line">            <span class="keyword">for</span> ( <span class="keyword">auto</span> kp:keypoints )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 去掉邻近边缘处的点</span></span><br><span class="line">                <span class="keyword">if</span> ( kp.pt.x &lt; <span class="number">20</span> || kp.pt.y &lt; <span class="number">20</span> || ( kp.pt.x+<span class="number">20</span> ) &gt;color.cols || ( kp.pt.y+<span class="number">20</span> ) &gt;color.rows )</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                ushort d = depth.ptr&lt;ushort&gt; ( cvRound ( kp.pt.y ) ) [ cvRound ( kp.pt.x ) ];</span><br><span class="line">                <span class="keyword">if</span> ( d==<span class="number">0</span> )</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                Eigen::Vector3d p3d = project2Dto3D ( kp.pt.x, kp.pt.y, d, fx, fy, cx, cy, depth_scale );</span><br><span class="line">                <span class="keyword">float</span> grayscale = <span class="keyword">float</span> ( gray.ptr&lt;uchar&gt; ( cvRound ( kp.pt.y ) ) [ cvRound ( kp.pt.x ) ] );</span><br><span class="line">                measurements.push_back ( Measurement ( p3d, grayscale ) );</span><br><span class="line">            &#125;</span><br><span class="line">            prev_color = color.clone();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 使用直接法计算相机运动</span></span><br><span class="line">        chrono::steady_clock::time_point t1 = chrono::steady_clock::now();</span><br><span class="line">        poseEstimationDirect ( measurements, &amp;gray, K, Tcw );</span><br><span class="line">        chrono::steady_clock::time_point t2 = chrono::steady_clock::now();</span><br><span class="line">        chrono::duration&lt;<span class="keyword">double</span>&gt; time_used = chrono::duration_cast&lt;chrono::duration&lt;<span class="keyword">double</span>&gt;&gt; ( t2-t1 );</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"direct method costs time: "</span>&lt;&lt;time_used.count() &lt;&lt;<span class="string">" seconds."</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"Tcw="</span>&lt;&lt;Tcw.matrix() &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// plot the feature points</span></span><br><span class="line">        cv::<span class="function">Mat <span class="title">img_show</span> <span class="params">( color.rows*<span class="number">2</span>, color.cols, CV_8UC3 )</span></span>;</span><br><span class="line">        prev_color.copyTo ( img_show ( cv::Rect ( <span class="number">0</span>,<span class="number">0</span>,color.cols, color.rows ) ) );</span><br><span class="line">        color.copyTo ( img_show ( cv::Rect ( <span class="number">0</span>,color.rows,color.cols, color.rows ) ) );</span><br><span class="line">        <span class="keyword">for</span> ( Measurement m:measurements )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//任何一次对 rand 的调用，都将得到一个 0~RAND_MAX 之间的伪随机数。</span></span><br><span class="line">            <span class="keyword">if</span> ( rand() &gt; RAND_MAX/<span class="number">5</span> )</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            Eigen::Vector3d p = m.pos_world;</span><br><span class="line">            Eigen::Vector2d pixel_prev = project3Dto2D ( p ( <span class="number">0</span>,<span class="number">0</span> ), p ( <span class="number">1</span>,<span class="number">0</span> ), p ( <span class="number">2</span>,<span class="number">0</span> ), fx, fy, cx, cy );</span><br><span class="line">            Eigen::Vector3d p2 = Tcw*m.pos_world;</span><br><span class="line">            Eigen::Vector2d pixel_now = project3Dto2D ( p2 ( <span class="number">0</span>,<span class="number">0</span> ), p2 ( <span class="number">1</span>,<span class="number">0</span> ), p2 ( <span class="number">2</span>,<span class="number">0</span> ), fx, fy, cx, cy );</span><br><span class="line">            <span class="keyword">if</span> ( pixel_now(<span class="number">0</span>,<span class="number">0</span>)&lt;<span class="number">0</span> || pixel_now(<span class="number">0</span>,<span class="number">0</span>)&gt;=color.cols || pixel_now(<span class="number">1</span>,<span class="number">0</span>)&lt;<span class="number">0</span> || pixel_now(<span class="number">1</span>,<span class="number">0</span>)&gt;=color.rows )</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">float</span> b = <span class="number">255</span>*<span class="keyword">float</span> ( rand() ) /RAND_MAX;</span><br><span class="line">            <span class="keyword">float</span> g = <span class="number">255</span>*<span class="keyword">float</span> ( rand() ) /RAND_MAX;</span><br><span class="line">            <span class="keyword">float</span> r = <span class="number">255</span>*<span class="keyword">float</span> ( rand() ) /RAND_MAX;</span><br><span class="line">            cv::circle ( img_show, cv::Point2d ( pixel_prev ( <span class="number">0</span>,<span class="number">0</span> ), pixel_prev ( <span class="number">1</span>,<span class="number">0</span> ) ), <span class="number">8</span>, cv::Scalar ( b,g,r ), <span class="number">2</span> );</span><br><span class="line">            cv::circle ( img_show, cv::Point2d ( pixel_now ( <span class="number">0</span>,<span class="number">0</span> ), pixel_now ( <span class="number">1</span>,<span class="number">0</span> ) +color.rows ), <span class="number">8</span>, cv::Scalar ( b,g,r ), <span class="number">2</span> );</span><br><span class="line">            cv::line ( img_show, cv::Point2d ( pixel_prev ( <span class="number">0</span>,<span class="number">0</span> ), pixel_prev ( <span class="number">1</span>,<span class="number">0</span> ) ), cv::Point2d ( pixel_now ( <span class="number">0</span>,<span class="number">0</span> ), pixel_now ( <span class="number">1</span>,<span class="number">0</span> ) +color.rows ), cv::Scalar ( b,g,r ), <span class="number">1</span> );</span><br><span class="line">        &#125;</span><br><span class="line">        cv::imshow ( <span class="string">"result"</span>, img_show );</span><br><span class="line">        cv::waitKey ( <span class="number">0</span> );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">poseEstimationDirect</span> <span class="params">( <span class="keyword">const</span> <span class="built_in">vector</span>&lt; Measurement &gt;&amp; measurements, cv::Mat* gray, Eigen::Matrix3f&amp; K, Eigen::Isometry3d&amp; Tcw )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化g2o</span></span><br><span class="line">    <span class="keyword">typedef</span> g2o::BlockSolver&lt;g2o::BlockSolverTraits&lt;<span class="number">6</span>,<span class="number">1</span>&gt;&gt; DirectBlock;  <span class="comment">// 求解的向量是6＊1的</span></span><br><span class="line">    DirectBlock::LinearSolverType* linearSolver = <span class="keyword">new</span> g2o::LinearSolverDense&lt; DirectBlock::PoseMatrixType &gt; ();</span><br><span class="line">    DirectBlock* solver_ptr = <span class="keyword">new</span> DirectBlock ( linearSolver );</span><br><span class="line">    <span class="comment">// g2o::OptimizationAlgorithmGaussNewton* solver = new g2o::OptimizationAlgorithmGaussNewton( solver_ptr ); // G-N</span></span><br><span class="line">    g2o::OptimizationAlgorithmLevenberg* solver = <span class="keyword">new</span> g2o::OptimizationAlgorithmLevenberg ( solver_ptr ); <span class="comment">// L-M</span></span><br><span class="line">    g2o::SparseOptimizer optimizer;</span><br><span class="line">    optimizer.setAlgorithm ( solver );</span><br><span class="line">    optimizer.setVerbose( <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">    g2o::VertexSE3Expmap* pose = <span class="keyword">new</span> g2o::VertexSE3Expmap();</span><br><span class="line">    pose-&gt;setEstimate ( g2o::SE3Quat ( Tcw.rotation(), Tcw.translation() ) );</span><br><span class="line">    pose-&gt;setId ( <span class="number">0</span> );</span><br><span class="line">    optimizer.addVertex ( pose );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加边</span></span><br><span class="line">    <span class="keyword">int</span> id=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> ( Measurement m: measurements )</span><br><span class="line">    &#123;</span><br><span class="line">        EdgeSE3ProjectDirect* edge = <span class="keyword">new</span> EdgeSE3ProjectDirect (</span><br><span class="line">            m.pos_world,</span><br><span class="line">            K ( <span class="number">0</span>,<span class="number">0</span> ), K ( <span class="number">1</span>,<span class="number">1</span> ), K ( <span class="number">0</span>,<span class="number">2</span> ), K ( <span class="number">1</span>,<span class="number">2</span> ), gray</span><br><span class="line">        );</span><br><span class="line">        edge-&gt;setVertex ( <span class="number">0</span>, pose );</span><br><span class="line">        edge-&gt;setMeasurement ( m.grayscale );</span><br><span class="line">        edge-&gt;setInformation ( Eigen::Matrix&lt;<span class="keyword">double</span>,<span class="number">1</span>,<span class="number">1</span>&gt;::Identity() );</span><br><span class="line">        edge-&gt;setId ( id++ );</span><br><span class="line">        optimizer.addEdge ( edge );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"edges in graph: "</span>&lt;&lt;optimizer.edges().size() &lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    optimizer.initializeOptimization();</span><br><span class="line">    optimizer.optimize ( <span class="number">30</span> );</span><br><span class="line">    Tcw = pose-&gt;estimate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-4-半稠密直接法"><a href="#5-4-半稠密直接法" class="headerlink" title="5.4 半稠密直接法"></a>5.4 半稠密直接法</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// select the pixels with high gradiants </span></span><br><span class="line"><span class="keyword">for</span> ( <span class="keyword">int</span> x=<span class="number">10</span>; x&lt;gray.cols<span class="number">-10</span>; x++ )</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> y=<span class="number">10</span>; y&lt;gray.rows<span class="number">-10</span>; y++ )</span><br><span class="line">    &#123;</span><br><span class="line">        Eigen::<span class="function">Vector2d <span class="title">delta</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            gray.ptr&lt;uchar&gt;(y)[x+<span class="number">1</span>] - gray.ptr&lt;uchar&gt;(y)[x<span class="number">-1</span>], </span></span></span><br><span class="line"><span class="function"><span class="params">            gray.ptr&lt;uchar&gt;(y+<span class="number">1</span>)[x] - gray.ptr&lt;uchar&gt;(y<span class="number">-1</span>)[x]</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line">        <span class="keyword">if</span> ( delta.norm() &lt; <span class="number">50</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        ushort d = depth.ptr&lt;ushort&gt; (y)[x];</span><br><span class="line">        <span class="keyword">if</span> ( d==<span class="number">0</span> )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        Eigen::Vector3d p3d = project2Dto3D ( x, y, d, fx, fy, cx, cy, depth_scale );</span><br><span class="line">        <span class="keyword">float</span> grayscale = <span class="keyword">float</span> ( gray.ptr&lt;uchar&gt; (y) [x] );</span><br><span class="line">        measurements.push_back ( Measurement ( p3d, grayscale ) );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-5-直接法的讨论"><a href="#5-5-直接法的讨论" class="headerlink" title="5.5 直接法的讨论"></a>5.5 直接法的讨论</h2><ol>
<li>相比于特征点法，直接法完全依靠优化来求解相机位姿,像 素梯度引导着优化的方向。如果我们想要得到正确的优化结果，就必须保证大部分像素梯 度能够把优化引导到正确的方向。</li>
</ol>
<ol>
<li><p>在非线性优化过程中，这个位姿是由一个初值不断地优化迭代得到的（可以大致赋值初值），我们的初值比较差。</p>
</li>
<li><p>直接法的梯度是直接由图像梯度确定的，因此我们必须保证沿着图像梯度走时，灰度误差会不断下降。然而，图像通常是一个很强烈的非凸函数。实际当中， 如果我们沿着图像梯度前进，很容易由于图像本身的非凸性（或噪声）落进一个局部极小值中，无法继续优化。==只有当相机运动很小，图像中的梯度不会有很强的非凸性时，直接法才能成立==。</p>
<h2 id="5-6-直接法的优缺点总结"><a href="#5-6-直接法的优缺点总结" class="headerlink" title="5.6 直接法的优缺点总结"></a>5.6 直接法的优缺点总结</h2></li>
<li><p>优点：</p>
<ul>
<li>可以省去计算特征点、描述子的时间。<ul>
<li>只要求有像素梯度即可，无须特征点。因此，直接法可以在特征缺失的场合下使用。</li>
<li>可以构建半稠密乃至稠密的地图，这是特征点法无法做到的。</li>
</ul>
</li>
</ul>
</li>
<li><p>缺点：</p>
<ul>
<li><strong>非凸性</strong>。直接法完全依靠梯度搜索，降低目标函数来计算相机位姿。其目标函数中需要取像素点的灰度值，而图像是强烈非凸的函数。这使得优化算法容易进入极小，只在运动很小时直接法才能成功。</li>
<li><strong>单个像素没有区分度</strong>。找一个和他像的实在太多了！——于是我们要么计算图像块，要么计算复杂的相关性。由于每个像素对改变相机运动的“意见”不一致。只能少数服从多数，以数量代替质量。</li>
<li><strong>灰度值不变是很强的假设</strong>。如果相机是自动曝光的，当它调整曝光参数时，会使得图像整体变亮或变暗。光照变化时亦会出现这种情况。特征点法对光照具有一定的容忍性，而直接法由于计算灰度间的差异，整体灰度变化会破坏灰度不变假设，使算法失败。</li>
</ul>
</li>
</ol>

    </div>
    
    
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>xiaohu
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiao-hu.com.cn/2019/05/25/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/" title="视觉slam十四讲 8.视觉里程计2">https://xiao-hu.com.cn/2019/05/25/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-8-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A12/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/05/21/%E8%A7%86%E8%A7%89slam%E5%8D%81%E5%9B%9B%E8%AE%B2-7-%E8%A7%86%E8%A7%89%E9%87%8C%E7%A8%8B%E8%AE%A11/" rel="next" title="视觉slam十四讲   7.视觉里程计1">
                  <i class="fa fa-chevron-left"></i> 视觉slam十四讲   7.视觉里程计1
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2019/05/28/%E4%BD%8D%E5%A7%BF%E5%9B%BE-Pose-Graph-%E4%BC%98%E5%8C%96/" rel="prev" title="位姿图(Pose Graph)优化">
                  位姿图(Pose Graph)优化 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  
  

  





  </div>


          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-直接法的引出"><span class="nav-number">1.</span> <span class="nav-text">1 直接法的引出</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-光流（Optical-Flow"><span class="nav-number">2.</span> <span class="nav-text">2 光流（Optical Flow)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-实践：LK光流"><span class="nav-number">3.</span> <span class="nav-text">3 实践：LK光流</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-使用TMU公开数据集"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 使用TMU公开数据集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-使用LK光流"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 使用LK光流</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-直接法"><span class="nav-number">4.</span> <span class="nav-text">4 直接法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-直接法的推导"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 直接法的推导</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-直接法的讨论"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 直接法的讨论</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-实践：RGB-D的直接法"><span class="nav-number">5.</span> <span class="nav-text">5 实践：RGB-D的直接法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-稀梳直接法"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 稀梳直接法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-半稠密直接法"><span class="nav-number">5.2.</span> <span class="nav-text">5.4 半稠密直接法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-直接法的讨论"><span class="nav-number">5.3.</span> <span class="nav-text">5.5 直接法的讨论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-6-直接法的优缺点总结"><span class="nav-number">5.4.</span> <span class="nav-text">5.6 直接法的优缺点总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="xiaohu"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">xiaohu</p>
  <div class="site-description" itemprop="description">博观而约取,厚积而薄发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Xiao-Hu-Z" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;Xiao-Hu-Z" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:znxxhn@gmail.com" title="E-Mail &amp;rarr; mailto:znxxhn@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaohu</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">554k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:23</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script><script src="/js/bookmark.js?v=7.4.2"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>






  <script src="/js/local-search.js?v=7.4.2"></script>













  

  
      
<script type="text/x-mathjax-config">
    MathJax.Ajax.config.path['mhchem'] = '//cdn.jsdelivr.net/npm/mathjax-mhchem@3';

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        extensions: ['[mhchem]/mhchem.js'],
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

  

  
  
  <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  
  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

